<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solaris | For Her</title>
    <style>
        :root {
            --void: #030305;
            --stardust: #e0e0e0;
            --accent-gold: #cfb53b;
            --nebula-purple: #4b0082;
            --event-horizon: #0b0c10;
            --glass: rgba(255, 255, 255, 0.03);
            --font-main: 'Cinzel', serif;
            --font-mono: 'Space Mono', monospace;
        }

        /* RESET & BASE */
        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
        
        html { scroll-behavior: smooth; }
        
        body {
            background-color: var(--void);
            color: var(--stardust);
            font-family: var(--font-main);
            overflow-x: hidden;
            min-height: 100vh;
            cursor: none; /* Custom cursor required */
        }

        /* UTILITIES */
        .hidden { opacity: 0; pointer-events: none; }
        .flex-center { display: flex; justify-content: center; align-items: center; }
        .absolute-fill { position: absolute; inset: 0; }

        /* CANVAS LAYER */
        #cosmos {
            position: fixed;
            top: 0; left: 0;
            width: 100vw; height: 100vh;
            z-index: -1;
            /* Hardware Acceleration hint */
            will-change: transform;
        }

        /* UI LAYERS */
        #ui-layer {
            position: relative;
            z-index: 10;
            width: 100%;
            max-width: 1000px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* CUSTOM CURSOR */
        #cursor {
            position: fixed;
            top: 0; left: 0;
            width: 20px; height: 20px;
            border: 1px solid var(--accent-gold);
            border-radius: 50%;
            pointer-events: none;
            z-index: 9999;
            transform: translate(-50%, -50%);
            transition: transform 0.1s ease-out;
            mix-blend-mode: difference;
        }
        #cursor-dot {
            position: fixed;
            width: 4px; height: 4px;
            background: var(--stardust);
            border-radius: 50%;
            pointer-events: none;
            z-index: 9999;
            transform: translate(-50%, -50%);
        }

        /* INTRO */
        .intro-screen {
            height: 100vh;
            flex-direction: column;
            background: var(--void);
            transition: opacity 1.2s cubic-bezier(0.16, 1, 0.3, 1);
        }
        
        .glitch-wrapper {
            font-size: clamp(2rem, 5vw, 4rem);
            letter-spacing: 0.2em;
            margin-bottom: 2rem;
            text-align: center;
            height: 1.2em; /* Prevent layout shift */
        }

        .btn-entry {
            padding: 15px 40px;
            background: transparent;
            border: 1px solid rgba(255,255,255,0.2);
            color: var(--stardust);
            font-family: var(--font-mono);
            text-transform: uppercase;
            letter-spacing: 2px;
            cursor: none;
            position: relative;
            overflow: hidden;
            transition: all 0.4s ease;
        }
        
        .btn-entry::after {
            content: '';
            position: absolute;
            top: 0; left: -100%;
            width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, var(--accent-gold), transparent);
            transition: 0.5s;
            opacity: 0.3;
        }
        
        .btn-entry:hover {
            border-color: var(--accent-gold);
            box-shadow: 0 0 15px rgba(207, 181, 59, 0.3);
        }
        .btn-entry:hover::after { left: 100%; }

        /* MAIN CONTENT */
        .section {
            padding: 10vh 0;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 1s ease, transform 1s ease;
        }
        .section.visible { opacity: 1; transform: translateY(0); }

        .header-title {
            text-align: center;
            font-size: 3rem;
            margin-bottom: 1rem;
            background: linear-gradient(to right, #fff, #666);
            -webkit-background-clip: text;
            color: transparent;
        }

        .subtitle {
            text-align: center;
            font-family: var(--font-mono);
            color: var(--accent-gold);
            font-size: 0.8rem;
            letter-spacing: 0.3em;
            margin-bottom: 4rem;
        }

        /* GALLERY GRID - HANDLING ASPECT RATIOS */
        /* K1 = Portrait, K2/K3 = Landscape */
        .memory-grid {
            display: grid;
            grid-template-columns: 1fr 1.5fr; /* Portrait takes less width */
            grid-template-rows: 1fr 1fr;
            gap: 20px;
            height: 80vh; /* Viewport constrained */
            margin-bottom: 100px;
        }

        /* Portrait Container */
        .frame-p {
            grid-row: 1 / -1; /* Spans full height */
            grid-column: 1;
        }
        
        /* Landscape Containers */
        .frame-l-1 { grid-column: 2; grid-row: 1; }
        .frame-l-2 { grid-column: 2; grid-row: 2; }

        .frame {
            position: relative;
            border: 1px solid rgba(255, 255, 255, 0.1);
            overflow: hidden;
            background: var(--event-horizon);
            transition: transform 0.5s cubic-bezier(0.2, 0.8, 0.2, 1);
        }

        .frame:hover { transform: scale(0.98); border-color: var(--accent-gold); }

        .frame img {
            width: 100%;
            height: 100%;
            object-fit: cover; /* Critical for aspect ratio handling */
            opacity: 0.8;
            transition: opacity 0.5s, transform 3s ease;
        }
        
        .frame:hover img { opacity: 1; transform: scale(1.1); }

        .loading-placeholder {
            position: absolute; inset: 0;
            background: repeating-linear-gradient(
                45deg,
                rgba(255,255,255,0.01),
                rgba(255,255,255,0.01) 10px,
                rgba(255,255,255,0.02) 10px,
                rgba(255,255,255,0.02) 20px
            );
        }

        /* POEM / TEXT */
        .poem-container {
            max-width: 600px;
            margin: 0 auto;
            text-align: justify;
            background: var(--glass);
            padding: 40px;
            border-left: 1px solid var(--accent-gold);
            backdrop-filter: blur(10px);
        }
        
        .poem-line {
            margin-bottom: 1.5rem;
            line-height: 1.8;
            font-size: 1.1rem;
        }
        
        .final-words {
            text-align: center;
            font-size: 1.5rem;
            margin-top: 3rem;
            color: var(--accent-gold);
            font-style: italic;
        }

        /* AUDIO PLAYER UI */
        .audio-control {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .visualizer {
            display: flex;
            align-items: flex-end;
            gap: 2px;
            height: 30px;
        }
        
        .v-bar {
            width: 3px;
            background: var(--accent-gold);
            height: 2px;
            transition: height 0.1s ease;
        }

        /* MOBILE OPTIMIZATION */
        @media (max-width: 768px) {
            .memory-grid {
                grid-template-columns: 1fr;
                grid-template-rows: auto;
                height: auto;
            }
            .frame-p { height: 60vh; grid-row: auto; }
            .frame-l-1, .frame-l-2 { height: 40vh; grid-row: auto; grid-column: auto; }
            #cursor, #cursor-dot { display: none; }
        }
        
        /* Fonts */
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600&family=Space+Mono&display=swap');
    </style>
</head>
<body>

    <!-- Canvas Engine -->
    <canvas id="cosmos"></canvas>
    
    <!-- Custom Cursor -->
    <div id="cursor"></div>
    <div id="cursor-dot"></div>

    <!-- Intro -->
    <div id="intro" class="intro-screen flex-center absolute-fill" style="z-index: 20;">
        <div class="glitch-wrapper" id="intro-text"></div>
        <button id="ignite-btn" class="btn-entry">Ignite Memory</button>
        <div style="margin-top: 20px; font-size: 0.7rem; color: #555; font-family: var(--font-mono);" id="loader-status">
            Initializing Core...
        </div>
    </div>

    <!-- Content -->
    <div id="ui-layer" class="hidden">
        
        <div class="section header-section">
            <h1 class="header-title">The Solar Return</h1>
            <p class="subtitle">orbiting greatness</p>
        </div>

        <!-- Gallery: Functional Layout for Specific Aspect Ratios -->
        <div class="section memory-grid">
            <!-- K1: Portrait -->
            <div class="frame frame-p">
                <div class="loading-placeholder"></div>
                <img data-src="K1.png" alt="Portrait of You" class="lazy-img">
            </div>
            <!-- K2: Landscape -->
            <div class="frame frame-l-1">
                <div class="loading-placeholder"></div>
                <img data-src="K2.png" alt="Landscape Memory 1" class="lazy-img">
            </div>
            <!-- K3: Landscape -->
            <div class="frame frame-l-2">
                <div class="loading-placeholder"></div>
                <img data-src="K3.png" alt="Landscape Memory 2" class="lazy-img">
            </div>
        </div>

        <!-- Poem -->
        <div class="section poem-container">
            <p class="poem-line">Time is not merely a sequence of moments, but a collection of gravities. Some days weigh heavy, others float like dust in a sunbeam. But today marks the point where your orbit completes another graceful revolution.</p>
            <p class="poem-line">I watch you navigate this world with a resilience that physics cannot explain. You carry light in places that were designed to remain dark. You bring order to chaos simply by being present.</p>
            <p class="poem-line">It isn't just about the years accumulated, but the sheer magnitude of who you have become. A force of nature, quiet yet undeniable. Elegant, yet formidable.</p>
            <div class="final-words">I love you.</div>
        </div>

        <div style="height: 20vh;"></div> <!-- Breathing space -->
    </div>

    <!-- Audio Control -->
    <div class="audio-control hidden" id="audio-panel">
        <div class="visualizer" id="viz">
            <!-- Generated by JS -->
        </div>
        <button class="btn-entry" style="padding: 5px 15px; font-size: 0.7rem;" id="mute-toggle">MUTE</button>
    </div>

    <!-- Hidden Audio Source -->
    <audio id="bg-audio" loop crossorigin="anonymous">
        <source src="fallen-down.mp3" type="audio/mpeg">
    </audio>

    <script>
        /**
         * PhD EXPERT SOLUTION
         * Paradigm: Functional Programming (FP)
         * Language: JavaScript (ES6+) treated with TypeScript discipline
         * Performance: TypedArrays, RequestAnimationFrame, IntersectionObserver
         */

        // --- 1. CORE TYPES & UTILS (The Functional Foundation) ---

        // Rust-like Result Type for robust error handling
        const Result = {
            Ok: (value) => ({ ok: true, value }),
            Err: (error) => ({ ok: false, error }),
            unwrap: (res) => res.ok ? res.value : (() => { throw res.error })(),
            map: (res, fn) => res.ok ? Result.Ok(fn(res.value)) : res
        };

        // Pipe function for composition
        const pipe = (...fns) => (x) => fns.reduce((v, f) => f(v), x);

        // Curry function for partial application
        const curry = (fn) => (...args) => 
            args.length >= fn.length ? fn(...args) : (...more) => curry(fn)(...args, ...more);

        // Safe DOM query
        const $$ = (selector) => document.querySelectorAll(selector);
        const $ = (selector) => document.querySelector(selector);

        // --- 2. HIGH-PERFORMANCE MATH & PHYSICS ---

        const MathLib = {
            lerp: (start, end, t) => start * (1 - t) + end * t,
            // Fast random range
            rand: (min, max) => Math.random() * (max - min) + min,
            // Optimized distance squared (avoids square root for perf)
            distSq: (x1, y1, x2, y2) => (x2 - x1)**2 + (y2 - y1)**2
        };

        // --- 3. THE ENGINE (Data-Oriented Particle System) ---
        // Instead of Classes, we use TypedArrays for memory locality.
        
        const createParticleSystem = (count, width, height) => {
            // Struct of Arrays (SoA) layout for cache efficiency
            const x = new Float32Array(count);
            const y = new Float32Array(count);
            const vx = new Float32Array(count);
            const vy = new Float32Array(count);
            const size = new Float32Array(count);
            const alpha = new Float32Array(count);
            
            // Initialization closure
            for (let i = 0; i < count; i++) {
                x[i] = Math.random() * width;
                y[i] = Math.random() * height;
                vx[i] = (Math.random() - 0.5) * 0.5;
                vy[i] = (Math.random() - 0.5) * 0.5;
                size[i] = Math.random() * 2;
                alpha[i] = Math.random();
            }

            return { count, x, y, vx, vy, size, alpha };
        };

        const updateParticles = (system, width, height) => {
            const { count, x, y, vx, vy, alpha } = system;
            
            for (let i = 0; i < count; i++) {
                x[i] += vx[i];
                y[i] += vy[i];

                // Wrap around logic
                if (x[i] < 0) x[i] = width;
                if (x[i] > width) x[i] = 0;
                if (y[i] < 0) y[i] = height;
                if (y[i] > height) y[i] = 0;

                // Twinkle effect using sin time is too slow? No, Math.sin is fast enough in JS JIT.
                // But let's use a simpler oscillation for pure speed.
                alpha[i] = 0.5 + 0.5 * Math.sin(Date.now() * 0.001 + i); 
            }
            return system; // Return for chaining
        };

        const drawParticles = (ctx, system, width, height) => {
            const { count, x, y, size, alpha } = system;
            ctx.clearRect(0, 0, width, height);
            
            // Batch drawing is hard with variable alpha, but we optimize state changes
            for (let i = 0; i < count; i++) {
                ctx.fillStyle = `rgba(255, 255, 255, ${alpha[i]})`;
                ctx.beginPath();
                ctx.arc(x[i], y[i], size[i], 0, Math.PI * 2);
                ctx.fill();
                
                // Draw connections (Optimization: Only check nearby particles? 
                // Too expensive O(N^2) for JS single thread with high count. 
                // We skip connection lines for "Breathing Space" aesthetic, 
                // keeping it subtle dust.)
            }
        };

        // --- 4. ASSET LOADER (Concurrency) ---

        const loadAudio = (url) => new Promise((resolve, reject) => {
            const audio = $('#bg-audio');
            // We don't actually fetch the blob to keep it streaming, 
            // but we check if it can play.
            audio.oncanplaythrough = () => resolve(Result.Ok(audio));
            audio.onerror = () => {
                console.warn(`Audio failed: ${url}`);
                resolve(Result.Err(`Missing: ${url}`)); // Graceful failure
            };
            // Set source if not set in HTML
             if(!audio.src) audio.src = url;
        });

        const loadImage = (imgElement) => new Promise((resolve) => {
            const src = imgElement.dataset.src;
            const img = new Image();
            img.src = src;
            img.onload = () => {
                imgElement.src = src;
                resolve(Result.Ok(src));
            };
            img.onerror = () => {
                console.warn(`Image failed: ${src}`);
                resolve(Result.Err(src)); // Non-fatal
            };
        });

        // --- 5. TEXT SCRAMBLE SYSTEM (Optimized) ---

        const scrambleText = (element, targetText, duration = 1000) => {
            const chars = '!<>-_\\/[]{}â€”=+*^?#';
            const length = Math.max(element.innerText.length, targetText.length);
            const startTime = performance.now();
            
            const animate = (currentTime) => {
                const progress = Math.min((currentTime - startTime) / duration, 1);
                
                let output = '';
                for (let i = 0; i < length; i++) {
                    if (i < targetText.length * progress) {
                        output += targetText[i];
                    } else {
                        output += chars[Math.floor(Math.random() * chars.length)];
                    }
                }
                
                element.innerText = output; // DOM Write
                
                if (progress < 1) {
                    requestAnimationFrame(animate);
                } else {
                    element.innerText = targetText; // Ensure final state
                }
            };
            requestAnimationFrame(animate);
        };

        // --- 6. AUDIO VISUALIZER (Web Audio API) ---

        const setupVisualizer = (audioEl) => {
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const source = ctx.createMediaElementSource(audioEl);
            const analyser = ctx.createAnalyser();
            analyser.fftSize = 32; // Low count for aesthetic minimalism
            source.connect(analyser);
            analyser.connect(ctx.destination);
            
            const bufferLength = analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);
            const bars = Array.from({length: 8}, () => document.createElement('div'));
            const container = $('#viz');
            
            bars.forEach(b => {
                b.className = 'v-bar';
                container.appendChild(b);
            });

            const updateViz = () => {
                analyser.getByteFrequencyData(dataArray);
                // Functional update of DOM elements
                bars.forEach((bar, i) => {
                    // Map low frequencies to the bars
                    const h = dataArray[i] / 2;
                    bar.style.height = `${Math.max(2, h)}px`;
                });
                requestAnimationFrame(updateViz);
            };

            return { ctx, updateViz };
        };

        // --- 7. MAIN ORCHESTRATOR ---

        const App = () => {
            // State
            const state = {
                particles: null,
                canvas: $('#cosmos'),
                ctx: $('#cosmos').getContext('2d', { alpha: false }), // Optimize
                width: window.innerWidth,
                height: window.innerHeight,
                isPlaying: false
            };

            // Resize Handler (Debounced would be better, but simple is fine here)
            window.addEventListener('resize', () => {
                state.width = window.innerWidth;
                state.height = window.innerHeight;
                state.canvas.width = state.width;
                state.canvas.height = state.height;
                state.particles = createParticleSystem(300, state.width, state.height);
            });

            // Init Canvas
            state.canvas.width = state.width;
            state.canvas.height = state.height;
            state.particles = createParticleSystem(300, state.width, state.height);

            // Animation Loop
            const loop = () => {
                updateParticles(state.particles, state.width, state.height);
                drawParticles(state.ctx, state.particles, state.width, state.height);
                requestAnimationFrame(loop);
            };
            requestAnimationFrame(loop);

            // Cursor Logic
            const cursor = $('#cursor');
            const dot = $('#cursor-dot');
            window.addEventListener('mousemove', (e) => {
                // Direct DOM manipulation is fastest here
                dot.style.transform = `translate(${e.clientX}px, ${e.clientY}px)`;
                // Add slight delay/lerp to outer circle via CSS transition, just set pos
                cursor.style.left = `${e.clientX}px`;
                cursor.style.top = `${e.clientY}px`;
            });

            // Lazy Load Observer
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('visible');
                        // If it's an image container, load the image
                        const img = entry.target.querySelector('img.lazy-img');
                        if (img && !img.src) {
                            loadImage(img);
                        }
                    }
                });
            }, { threshold: 0.1 });

            $$('.section').forEach(el => observer.observe(el));

            // Intro Sequence
            const introText = $('#intro-text');
            const btn = $('#ignite-btn');
            
            // Text Animation
            setTimeout(() => scrambleText(introText, "HAPPY BIRTHDAY", 1500), 500);

            // Interaction
            btn.addEventListener('click', async () => {
                const audio = $('#bg-audio');
                const intro = $('#intro');
                const ui = $('#ui-layer');
                const audioPanel = $('#audio-panel');

                // Audio Context requires user gesture
                try {
                    const vizSystem = setupVisualizer(audio);
                    if (vizSystem.ctx.state === 'suspended') {
                        await vizSystem.ctx.resume();
                    }
                    audio.play().catch(e => console.log("Autoplay prevented", e));
                    vizSystem.updateViz(); // Start viz loop
                } catch (e) {
                    console.warn("Audio system issue:", e);
                }

                // UI Transition
                intro.style.opacity = '0';
                setTimeout(() => {
                    intro.classList.add('hidden');
                    ui.classList.remove('hidden');
                    audioPanel.classList.remove('hidden');
                    
                    // Trigger reflow/anim for first section
                    $('.header-section').classList.add('visible');
                }, 1000);
            });

            // Mute Toggle
            $('#mute-toggle').addEventListener('click', (e) => {
                const audio = $('#bg-audio');
                audio.muted = !audio.muted;
                e.target.innerText = audio.muted ? "UNMUTE" : "MUTE";
            });
        };

        // Boot
        window.addEventListener('DOMContentLoaded', App);

    </script>
</body>
</html>
