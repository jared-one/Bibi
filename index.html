<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="color-scheme" content="dark" />
  <title>For You | A Birthday Memory</title>

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600&family=Dancing+Script:wght@600&display=swap" rel="stylesheet">

  <style>
    :root{
      --space-black:#050505;
      --nebula:#0a1a2f;
      --starlight:#e7e7ff;
      --muted:rgba(231,231,255,.65);
      --cosmic-purple:#7b2cbf;
      --gravity-cyan:#00f2ff;
      --gold:#ffd700;

      --glass: rgba(255,255,255,.045);
      --glass-2: rgba(255,255,255,.03);
      --stroke: rgba(255,255,255,.08);
      --stroke-2: rgba(0,242,255,.18);

      --max: 920px;
      --radius: 18px;
      --shadow: 0 18px 50px rgba(0,0,0,.55);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; }
    body{
      background: var(--space-black);
      color: var(--starlight);
      font-family: Cinzel, Georgia, serif;
      overflow-x: hidden;
    }

    /* Background canvas */
    #universe{
      position: fixed;
      inset: 0;
      width: 100%;
      height: 100%;
      z-index: -2;
      background: radial-gradient(circle at 20% 85%, #1a0b2e 0%, #06060b 45%, #000 100%);
    }

    /* Subtle grain */
    .grain{
      pointer-events: none;
      position: fixed;
      inset: 0;
      z-index: -1;
      opacity: .08;
      mix-blend-mode: overlay;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='180' height='180'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.9' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='180' height='180' filter='url(%23n)' opacity='.55'/%3E%3C/svg%3E");
      background-size: 180px 180px;
    }

    /* Boot screen */
    #boot{
      position: fixed;
      inset: 0;
      z-index: 50;
      display: grid;
      place-items: center;
      background: rgba(0,0,0,.82);
      backdrop-filter: blur(10px);
      transition: opacity 900ms ease, visibility 900ms ease;
    }
    #boot.hidden{
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
    }
    .boot-card{
      width: min(720px, calc(100% - 40px));
      padding: 34px 26px;
      border-radius: 22px;
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border: 1px solid var(--stroke);
      box-shadow: var(--shadow);
      text-align: center;
    }
    .kicker{
      font-size: .78rem;
      letter-spacing: .38em;
      color: rgba(0,242,255,.72);
      text-transform: uppercase;
    }
    .boot-title{
      margin-top: 14px;
      font-weight: 600;
      letter-spacing: .22em;
      text-transform: uppercase;
      font-size: clamp(1.7rem, 4.6vw, 3rem);
      color: transparent;
      background: linear-gradient(90deg, rgba(255,255,255,.95), rgba(195,195,210,.75));
      -webkit-background-clip: text;
      background-clip: text;
      min-height: 1.25em;
    }
    .boot-sub{
      margin-top: 14px;
      color: var(--muted);
      font-size: .95rem;
      line-height: 1.7;
      max-width: 56ch;
      margin-left: auto;
      margin-right: auto;
    }
    .progress{
      margin: 22px auto 0;
      width: min(520px, 100%);
      height: 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.06);
      overflow: hidden;
      border: 1px solid rgba(255,255,255,.08);
    }
    .progress > i{
      display: block;
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, rgba(123,44,191,.8), rgba(0,242,255,.85));
      box-shadow: 0 0 18px rgba(0,242,255,.18);
      transition: width 180ms linear;
    }
    .boot-meta{
      margin-top: 12px;
      display: flex;
      justify-content: space-between;
      gap: 10px;
      font-size: .78rem;
      color: rgba(231,231,255,.55);
    }

    .enter-row{
      margin-top: 26px;
      display: flex;
      justify-content: center;
      gap: 12px;
      flex-wrap: wrap;
    }
    .btn{
      appearance: none;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(0,0,0,.18);
      color: rgba(255,255,255,.92);
      padding: 12px 18px;
      border-radius: 999px;
      font-family: inherit;
      letter-spacing: .18em;
      text-transform: uppercase;
      font-size: .78rem;
      transition: transform .2s ease, border-color .25s ease, box-shadow .25s ease, background .25s ease;
      cursor: pointer;
    }
    .btn:hover{
      transform: translateY(-1px);
      border-color: var(--stroke-2);
      box-shadow: 0 0 0 6px rgba(0,242,255,.05);
    }
    .btn.primary{
      border-color: rgba(0,242,255,.25);
      background: linear-gradient(90deg, rgba(123,44,191,.22), rgba(0,242,255,.12));
    }
    .btn:disabled{
      opacity: .5;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    /* Main layout */
    main{
      opacity: 0;
      transition: opacity 900ms ease;
    }
    main.visible{ opacity: 1; }

    .wrap{
      max-width: var(--max);
      margin: 0 auto;
      padding: 96px 22px 110px;
    }

    header.hero{
      text-align: center;
      margin-bottom: 70px;
    }
    .hero h1{
      font-weight: 600;
      letter-spacing: .16em;
      text-transform: uppercase;
      font-size: clamp(1.9rem, 5.2vw, 3.2rem);
    }
    .hero .sub{
      margin-top: 10px;
      color: rgba(0,242,255,.7);
      letter-spacing: .36em;
      text-transform: uppercase;
      font-size: .82rem;
    }
    .hero .note{
      margin-top: 18px;
      color: var(--muted);
      line-height: 1.85;
      max-width: 68ch;
      margin-left: auto;
      margin-right: auto;
      font-size: 1.02rem;
    }

    /* Sections */
    section{
      margin-top: 58px;
    }
    .section-title{
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 18px;
      padding: 0 2px 14px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      margin-bottom: 22px;
    }
    .section-title h2{
      font-size: 1.02rem;
      letter-spacing: .28em;
      text-transform: uppercase;
      font-weight: 600;
      color: rgba(231,231,255,.92);
    }
    .section-title span{
      color: rgba(231,231,255,.55);
      font-size: .8rem;
      letter-spacing: .12em;
      text-transform: uppercase;
    }

    /* Music player */
    .player{
      background: linear-gradient(145deg, rgba(255,255,255,.03), rgba(255,255,255,.02));
      border: 1px solid rgba(255,255,255,.08);
      border-radius: var(--radius);
      padding: 18px 18px 16px;
      box-shadow: 0 12px 36px rgba(0,0,0,.4);
    }
    .player-top{
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 14px;
      flex-wrap: wrap;
    }
    .track{
      display: grid;
      gap: 4px;
    }
    .track strong{
      font-size: 1.02rem;
      font-weight: 600;
      letter-spacing: .08em;
    }
    .track small{
      color: rgba(231,231,255,.6);
      font-family: Georgia, serif;
      font-style: italic;
      letter-spacing: .06em;
    }
    .controls{
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }
    .pill{
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      border-radius: 999px;
      padding: 8px 10px;
      display: inline-flex;
      align-items: center;
      gap: 10px;
    }
    .pill label{
      font-size: .72rem;
      letter-spacing: .16em;
      text-transform: uppercase;
      color: rgba(231,231,255,.55);
    }
    input[type="range"]{
      accent-color: var(--gravity-cyan);
      width: 140px;
    }

    .timeline{
      margin-top: 14px;
      display: grid;
      gap: 10px;
    }
    .time-row{
      display: flex;
      justify-content: space-between;
      font-size: .76rem;
      color: rgba(231,231,255,.55);
      letter-spacing: .1em;
    }
    .seek{
      width: 100%;
    }

    .viz{
      margin-top: 12px;
      height: 62px;
      border-radius: 14px;
      background: rgba(255,255,255,.03);
      border: 1px solid rgba(255,255,255,.06);
      display: flex;
      align-items: flex-end;
      justify-content: center;
      gap: 3px;
      padding: 10px 10px;
      overflow: hidden;
    }
    .bar{
      width: 4px;
      height: 6px;
      border-radius: 2px;
      background: linear-gradient(180deg, rgba(123,44,191,.9), rgba(0,242,255,.85));
      will-change: height;
    }

    /* Gallery */
    .grid{
      display: grid;
      gap: 18px;
      grid-template-columns: 1.05fr .95fr;
      align-items: stretch;
    }
    @media (max-width: 860px){
      .grid{ grid-template-columns: 1fr; }
    }
    figure.frame{
      position: relative;
      border-radius: 20px;
      overflow: hidden;
      border: 1px solid rgba(255,255,255,.08);
      background: radial-gradient(circle at 30% 20%, rgba(0,242,255,.08), rgba(0,0,0,.2) 55%, rgba(0,0,0,.35));
      box-shadow: 0 18px 50px rgba(0,0,0,.48);
      min-height: 260px;
      cursor: pointer;
      transition: transform .25s ease, border-color .25s ease;
    }
    figure.frame:hover{
      transform: translateY(-2px);
      border-color: rgba(0,242,255,.22);
    }
    figure.frame img{
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
      filter: contrast(1.04) saturate(.95);
      transform: scale(1.01);
    }
    .portrait{ aspect-ratio: 3 / 4; }
    .landscape{ aspect-ratio: 16 / 10; }
    .stack{
      display: grid;
      gap: 18px;
    }
    figcaption{
      position: absolute;
      inset: auto 0 0 0;
      padding: 16px 16px 14px;
      background: linear-gradient(180deg, transparent, rgba(0,0,0,.72));
      display: grid;
      gap: 6px;
    }
    figcaption strong{
      letter-spacing: .16em;
      text-transform: uppercase;
      font-size: .86rem;
      font-weight: 600;
    }
    figcaption span{
      color: rgba(231,231,255,.66);
      font-size: .9rem;
      font-family: Georgia, serif;
      font-style: italic;
      line-height: 1.55;
    }
    figure.frame.broken{
      cursor: default;
    }
    figure.frame.broken img{ display:none; }
    figure.frame.broken::before{
      content:"Missing asset";
      position:absolute;
      inset:0;
      display:grid;
      place-items:center;
      color: rgba(231,231,255,.6);
      letter-spacing:.2em;
      text-transform: uppercase;
      font-size:.8rem;
    }

    /* Constellation */
    .constellation{
      display: grid;
      grid-template-columns: 1fr 340px;
      gap: 18px;
      align-items: stretch;
    }
    @media (max-width: 900px){
      .constellation{ grid-template-columns: 1fr; }
    }
    .skybox{
      border-radius: 20px;
      overflow: hidden;
      border: 1px solid rgba(255,255,255,.08);
      background: linear-gradient(180deg, rgba(10,26,47,.42), rgba(0,0,0,.2));
      box-shadow: 0 18px 50px rgba(0,0,0,.45);
      min-height: 320px;
      position: relative;
    }
    #constellationCanvas{
      width: 100%;
      height: 100%;
      display: block;
    }
    .constellation-panel{
      border-radius: 20px;
      border: 1px solid rgba(255,255,255,.08);
      background: linear-gradient(145deg, rgba(255,255,255,.03), rgba(255,255,255,.015));
      padding: 18px;
      box-shadow: 0 18px 50px rgba(0,0,0,.35);
      display: grid;
      gap: 14px;
      align-content: start;
    }
    .constellation-panel p{
      color: rgba(231,231,255,.78);
      line-height: 1.9;
      font-size: .98rem;
    }
    .constellation-quote{
      padding: 14px 14px;
      border-radius: 16px;
      border: 1px solid rgba(0,242,255,.16);
      background: rgba(0,242,255,.04);
      min-height: 4.4em;
      display: grid;
      align-items: center;
      color: rgba(231,231,255,.92);
      font-family: Georgia, serif;
      font-style: italic;
      line-height: 1.7;
    }
    .hint{
      color: rgba(231,231,255,.55);
      font-size: .78rem;
      letter-spacing: .14em;
      text-transform: uppercase;
      line-height: 1.6;
    }

    /* Letter */
    .letter{
      border-radius: 22px;
      border: 1px solid rgba(255,255,255,.08);
      background: linear-gradient(145deg, rgba(255,255,255,.03), rgba(255,255,255,.018));
      padding: 28px 22px;
      border-left: 2px solid rgba(123,44,191,.6);
      box-shadow: 0 18px 50px rgba(0,0,0,.4);
    }
    .letter p{
      margin-bottom: 16px;
      line-height: 1.9;
      font-size: 1.05rem;
      color: rgba(231,231,255,.86);
      font-family: Georgia, serif;
    }
    .letter p:last-child{ margin-bottom: 0; }
    .hl{
      color: rgba(0,242,255,.82);
      text-shadow: 0 0 10px rgba(0,242,255,.12);
      font-style: normal;
    }

    /* Footer signature */
    .sig{
      margin-top: 74px;
      text-align: center;
      font-family: "Dancing Script", cursive;
      font-size: clamp(1.8rem, 4vw, 2.4rem);
      color: transparent;
      background: linear-gradient(90deg, rgba(0,242,255,.85), rgba(123,44,191,.9));
      -webkit-background-clip: text;
      background-clip: text;
      padding-bottom: 34px;
    }

    /* Lightbox */
    dialog#lightbox{
      width: min(980px, calc(100% - 24px));
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 18px;
      padding: 0;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(10px);
      box-shadow: 0 30px 80px rgba(0,0,0,.75);
      color: var(--starlight);
    }
    dialog::backdrop{ background: rgba(0,0,0,.72); }
    .lb{
      display: grid;
      grid-template-rows: auto 1fr auto;
    }
    .lb-top{
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 14px;
      border-bottom: 1px solid rgba(255,255,255,.08);
    }
    .lb-top strong{
      letter-spacing: .22em;
      text-transform: uppercase;
      font-size: .78rem;
      color: rgba(231,231,255,.7);
    }
    .lb-body{
      padding: 12px;
      display: grid;
      place-items: center;
      background: radial-gradient(circle at 30% 20%, rgba(0,242,255,.08), rgba(0,0,0,.25) 60%, rgba(0,0,0,.45));
    }
    .lb-body img{
      max-width: 100%;
      max-height: 70vh;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.12);
      object-fit: contain;
      background: rgba(0,0,0,.2);
    }
    .lb-bottom{
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      padding: 12px 14px;
      border-top: 1px solid rgba(255,255,255,.08);
      color: rgba(231,231,255,.6);
      font-size: .78rem;
      letter-spacing: .12em;
      text-transform: uppercase;
    }

    /* Reveal animations (respect reduced motion) */
    .reveal{
      opacity: 0;
      transform: translateY(18px);
      transition: opacity 700ms cubic-bezier(.2,.9,.2,1), transform 700ms cubic-bezier(.2,.9,.2,1);
      will-change: opacity, transform;
    }
    .reveal.in{
      opacity: 1;
      transform: translateY(0);
    }
    @media (prefers-reduced-motion: reduce){
      *{ scroll-behavior: auto !important; }
      .reveal{ transition: none; transform: none; opacity: 1; }
      #boot{ transition: none; }
      .btn{ transition: none; }
      figure.frame{ transition: none; }
    }
  </style>
</head>
<body>
  <canvas id="universe" aria-hidden="true"></canvas>
  <div class="grain" aria-hidden="true"></div>

  <!-- Boot / Entry -->
  <div id="boot" role="dialog" aria-modal="true" aria-label="Entry screen">
    <div class="boot-card">
      <div class="kicker">A small archive of light</div>
      <div id="bootTitle" class="boot-title">HAPPY BIRTHDAY</div>
      <p class="boot-sub">
        This page loads gently on purpose: images, music, and the background sky. If anything fails, it will not break—check the console for a quiet note.
      </p>

      <div class="progress" aria-label="Loading progress">
        <i id="progBar"></i>
      </div>
      <div class="boot-meta">
        <span id="progText">Preparing…</span>
        <span id="assetText">0/4</span>
      </div>

      <div class="enter-row">
        <button id="enterBtn" class="btn primary" disabled>Enter</button>
        <button id="muteBtn" class="btn" type="button">Start Silent</button>
      </div>
    </div>
  </div>

  <main id="app" aria-hidden="true">
    <div class="wrap">

      <header class="hero reveal">
        <h1>
          Happy Birthday,
          <span id="nameSlot" style="color: rgba(0,242,255,.85); text-shadow: 0 0 16px rgba(0,242,255,.12);">my love</span>
        </h1>
        <div class="sub">kept like a memory</div>
        <p class="note">
          Not a scrapbook of events—just a space that holds what matters most:
          your presence, your brilliance, and the quiet way you make the world feel more deliberate.
        </p>
      </header>

      <section class="reveal" aria-label="Music">
        <div class="section-title">
          <h2>Sound</h2><span>optional, but fitting</span>
        </div>

        <div class="player" role="group" aria-label="Music player">
          <div class="player-top">
            <div class="track">
              <strong>Fallen Down</strong>
              <small>— a soft loop for a birthday memory</small>
            </div>

            <div class="controls">
              <button id="playBtn" class="btn primary" type="button">Play</button>
              <div class="pill" aria-label="Volume control">
                <label for="vol">Vol</label>
                <input id="vol" type="range" min="0" max="1" step="0.01" value="0.7" />
              </div>
            </div>
          </div>

          <div class="timeline">
            <input id="seek" class="seek" type="range" min="0" max="1000" step="1" value="0" aria-label="Seek" />
            <div class="time-row">
              <span id="tNow">00:00</span>
              <span id="tEnd">--:--</span>
            </div>
          </div>

          <div id="viz" class="viz" aria-label="Audio visualizer"></div>

          <audio id="bgm" preload="auto" loop>
            <source src="fallen-down.mp3" type="audio/mpeg">
          </audio>
        </div>
      </section>

      <section class="reveal" aria-label="Gallery">
        <div class="section-title">
          <h2>Fragments</h2><span>tap to enlarge</span>
        </div>

        <div class="grid" id="gallery">
          <figure class="frame portrait" data-idx="0">
            <img id="imgK1" src="K1.png" alt="Portrait photo" loading="eager" decoding="async" />
            <figcaption>
              <strong>Portrait</strong>
              <span>Composure with depth—like the night sky pretending to be simple.</span>
            </figcaption>
          </figure>

          <div class="stack">
            <figure class="frame landscape" data-idx="1">
              <img id="imgK2" src="K2.png" alt="Landscape photo 1" loading="lazy" decoding="async" />
              <figcaption>
                <strong>Light</strong>
                <span>The kind that doesn’t shout—just stays.</span>
              </figcaption>
            </figure>

            <figure class="frame landscape" data-idx="2">
              <img id="imgK3" src="K3.png" alt="Landscape photo 2" loading="lazy" decoding="async" />
              <figcaption>
                <strong>Stillness</strong>
                <span>Proof that calm can be powerful.</span>
              </figcaption>
            </figure>
          </div>
        </div>
      </section>

      <section class="reveal" aria-label="Constellation">
        <div class="section-title">
          <h2>Constellation</h2><span>click the sky</span>
        </div>

        <div class="constellation">
          <div class="skybox">
            <canvas id="constellationCanvas" aria-label="Interactive constellation canvas"></canvas>
          </div>
          <aside class="constellation-panel">
            <p>
              A constellation is not a place; it’s a way of seeing.
              Click to draw the next line—each one true, each one simple.
            </p>
            <div id="quote" class="constellation-quote">
              (Waiting.)
            </div>
            <div class="hint">
              Tip: this section activates only when visible, to keep the page fast and calm.
            </div>
          </aside>
        </div>
      </section>

      <section class="reveal" aria-label="Letter">
        <div class="section-title">
          <h2>Letter</h2><span>read slowly</span>
        </div>

        <div class="letter">
          <p>
            Today isn’t about fireworks. It’s about the steady things that last—
            the way you carry <span class="hl">strength</span> without making it a spectacle,
            the way your <span class="hl">intelligence</span> feels calm instead of sharp,
            and the way your <span class="hl">kindness</span> remains precise even when the world isn’t.
          </p>
          <p>
            You have a rare ability to make presence feel like care.
            To turn silence into something safe.
            To make beauty feel earned—not performed.
          </p>
          <p>
            So here is my wish: that this year treats you gently,
            that your days feel spacious,
            and that you never forget how extraordinary you are—without needing any proof beyond yourself.
          </p>
          <p><span class="hl">I love you.</span></p>
        </div>
      </section>

      <div class="sig reveal">Always — and happy birthday.</div>
    </div>
  </main>

  <!-- Lightbox -->
  <dialog id="lightbox" aria-label="Image viewer">
    <div class="lb">
      <div class="lb-top">
        <strong id="lbTitle">Fragment</strong>
        <button id="lbClose" class="btn" type="button">Close</button>
      </div>
      <div class="lb-body">
        <img id="lbImg" alt="Enlarged image" />
      </div>
      <div class="lb-bottom">
        <span id="lbMeta">—</span>
        <span>ESC to close • ← → to navigate</span>
      </div>
    </div>
  </dialog>

  <script type="module">
    /**
     * TS-like JSDoc typing for clarity without bloating runtime.
     * @typedef {{ id: string, kind: 'image'|'audio', src: string }} Asset
     * @typedef {{ id: string, ok: boolean, ms: number, error?: unknown }} AssetResult
     */

    // ---------------------------
    // Functional utilities (pure)
    // ---------------------------
    /** @type {(n:number, a:number, b:number)=>number} */
    const clamp = (n, a, b) => (n < a ? a : (n > b ? b : n));

    /** @type {(t:number)=>number} */
    const easeOutCubic = (t) => 1 - Math.pow(1 - t, 3);

    /** @type {(ms:number)=>Promise<void>} */
    const sleep = (ms) => new Promise(r => setTimeout(r, ms));

    /** @type {(s:string)=>number} */
    const fnv1a32 = (s) => {
      let h = 0x811c9dc5;
      for (let i = 0; i < s.length; i++){
        h ^= s.charCodeAt(i);
        h = Math.imul(h, 0x01000193);
      }
      return h >>> 0;
    };

    /** @type {(seed:number)=>()=>number} */
    const mulberry32 = (seed) => () => {
      let t = (seed += 0x6D2B79F5) >>> 0;
      t = Math.imul(t ^ (t >>> 15), t | 1);
      t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
      return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
    };

    /** @type {(sec:number)=>string} */
    const fmtTime = (sec) => {
      const s = Math.max(0, Math.floor(sec));
      const m = Math.floor(s / 60);
      const r = s % 60;
      return String(m).padStart(2,'0') + ':' + String(r).padStart(2,'0');
    };

    /** @type {<T>(x:T)=>T} */
    const freeze = (x) => Object.freeze(x);

    // ---------------------------
    // DOM helpers (small shell)
    // ---------------------------
    /** @type {(sel:string, root?:Document|HTMLElement)=>HTMLElement} */
    const $ = (sel, root = document) => /** @type {HTMLElement} */ (root.querySelector(sel));

    /** @type {(sel:string, root?:Document|HTMLElement)=>HTMLElement[]} */
    const $$ = (sel, root = document) => Array.from(root.querySelectorAll(sel));

    const log = {
      info: (...a) => console.log('[birthday]', ...a),
      warn: (...a) => console.warn('[birthday]', ...a),
      err:  (...a) => console.error('[birthday]', ...a),
    };

    // ---------------------------
    // Fast title scramble (optimized)
    // ---------------------------
    /**
     * Time-based scramble: O(len) per frame, no per-char queue arrays, no innerHTML spans.
     * @type {(el:HTMLElement, toText:string, ms:number, rng:()=>number)=>Promise<void>}
     */
    const scrambleTo = async (el, toText, ms, rng) => {
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789—-=+*?';
      const from = (el.textContent ?? '').trim();
      const target = toText;
      const L = Math.max(from.length, target.length);
      const start = performance.now();

      // Pre-pad to avoid layout jitter.
      el.textContent = target.padEnd(L, ' ');

      return new Promise((resolve) => {
        /** @type {(now:number)=>void} */
        const step = (now) => {
          const t = clamp((now - start) / ms, 0, 1);
          const k = Math.floor(easeOutCubic(t) * L);

          // Build in a single pass.
          let out = '';
          for (let i = 0; i < L; i++){
            if (i < k) out += (target[i] ?? ' ');
            else out += chars[(rng() * chars.length) | 0];
          }
          el.textContent = out;

          if (t >= 1){
            el.textContent = target;
            resolve();
            return;
          }
          requestAnimationFrame(step);
        };
        requestAnimationFrame(step);
      });
    };

    // ---------------------------
    // Asset loading (robust; never throws)
    // ---------------------------
    /** @type {(src:string)=>Promise<AssetResult>} */
    const loadImage = (src) => new Promise((resolve) => {
      const t0 = performance.now();
      const img = new Image();
      img.decoding = 'async';
      img.loading = 'eager';
      img.onload = () => resolve({ id: src, ok: true, ms: performance.now() - t0 });
      img.onerror = (error) => resolve({ id: src, ok: false, ms: performance.now() - t0, error });
      img.src = src;
    });

    /** @type {(audio:HTMLAudioElement)=>Promise<AssetResult>} */
    const loadAudio = (audio) => new Promise((resolve) => {
      const t0 = performance.now();
      const done = (ok, error) => resolve({ id: 'fallen-down.mp3', ok, ms: performance.now() - t0, error });

      const onOk = () => { cleanup(); done(true, undefined); };
      const onErr = (e) => { cleanup(); done(false, e); };

      const cleanup = () => {
        audio.removeEventListener('canplaythrough', onOk);
        audio.removeEventListener('loadedmetadata', onOk);
        audio.removeEventListener('error', onErr);
      };

      audio.addEventListener('canplaythrough', onOk, { once: true });
      audio.addEventListener('loadedmetadata', onOk, { once: true });
      audio.addEventListener('error', onErr, { once: true });

      try {
        audio.load();
      } catch (e) {
        cleanup();
        done(false, e);
      }
    });

    // ---------------------------
    // Starfield (typed arrays; minimal allocations)
    // ---------------------------
    /**
     * @typedef {{
     *  resize:(w:number,h:number,dpr:number)=>void,
     *  tick:(dt:number)=>void,
     *  draw:(ctx:CanvasRenderingContext2D)=>void
     * }} Starfield
     */

    /** @type {(count:number, rng:()=>number)=>Starfield} */
    const makeStarfield = (count, rng) => {
      const X = new Float32Array(count);
      const Y = new Float32Array(count);
      const Z = new Float32Array(count);
      const C = new Uint8Array(count); // 0 white, 1 cyan, 2 purple

      let w = 1, h = 1, dpr = 1;
      const depth = 1800;
      let speed = 120;        // units per second
      let warp = 0;           // extra speed burst
      let targetWarp = 0;

      /** @type {(i:number, initial:boolean)=>void} */
      const reset = (i, initial) => {
        X[i] = (rng() - 0.5) * w;
        Y[i] = (rng() - 0.5) * h;
        Z[i] = initial ? rng() * depth : depth;
        const r = rng();
        C[i] = r > 0.88 ? 1 : (r > 0.80 ? 2 : 0);
      };

      for (let i = 0; i < count; i++) reset(i, true);

      return freeze({
        resize: (W, H, DPR) => {
          w = Math.max(1, W);
          h = Math.max(1, H);
          dpr = Math.max(1, DPR);
        },
        tick: (dt) => {
          // Ease warp (Rust-like “structured” speed control: bounded & deterministic).
          warp += (targetWarp - warp) * Math.min(1, dt * 6);
          const v = speed + warp;

          for (let i = 0; i < count; i++){
            Z[i] -= v * dt;
            if (Z[i] <= 1) reset(i, false);
          }
        },
        draw: (ctx) => {
          // Trail / fade
          ctx.save();
          ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
          ctx.fillStyle = 'rgba(5,5,5,0.28)';
          ctx.fillRect(0, 0, w, h);

          const cx = w * 0.5;
          const cy = h * 0.5;

          // Draw in 3 passes to minimize fillStyle changes.
          /** @type {(cIndex:0|1|2, style:string)=>void} */
          const pass = (cIndex, style) => {
            ctx.fillStyle = style;
            for (let i = 0; i < count; i++){
              if (C[i] !== cIndex) continue;

              const z = Z[i];
              const px = (X[i] / z) * 520 + cx;
              const py = (Y[i] / z) * 520 + cy;

              if (px < 0 || px > w || py < 0 || py > h) continue;

              const a = clamp((depth - z) / 900, 0, 1);
              const s = Math.max(1, (depth / z) * 0.9);

              ctx.globalAlpha = a;
              ctx.fillRect(px, py, s, s);
            }
          };

          pass(0, '#ffffff');
          pass(1, '#00f2ff');
          pass(2, '#7b2cbf');

          ctx.restore();
        }
      });
    };

    // ---------------------------
    // Audio: lazy analyser + fallback viz
    // ---------------------------
    /** @type {(vizEl:HTMLElement, bars:number)=>HTMLDivElement[]} */
    const initBars = (vizEl, bars) => {
      vizEl.textContent = '';
      const frag = document.createDocumentFragment();
      /** @type {HTMLDivElement[]} */
      const out = [];
      for (let i = 0; i < bars; i++){
        const b = document.createElement('div');
        b.className = 'bar';
        frag.appendChild(b);
        out.push(b);
      }
      vizEl.appendChild(frag);
      return out;
    };

    /** @type {(bars:HTMLDivElement[], data:Uint8Array)=>void} */
    const paintBars = (bars, data) => {
      const n = bars.length;
      const m = data.length;
      for (let i = 0; i < n; i++){
        const v = data[i % m] / 255;
        const h = 6 + Math.round(v * 44);
        bars[i].style.height = h + 'px';
      }
    };

    // ---------------------------
    // Constellation canvas (lazy init)
    // ---------------------------
    /** @type {(canvas:HTMLCanvasElement, quoteEl:HTMLElement, rng:()=>number)=>()=>void} */
    const makeConstellation = (canvas, quoteEl, rng) => {
      const ctx = canvas.getContext('2d');
      if (!ctx){
        log.warn('Constellation: canvas context unavailable.');
        return () => {};
      }

      const lines = freeze([
        "You are rare: calm, brilliant, and unmistakably yourself.",
        "Your presence has weight—in the best way. It makes things steadier.",
        "You have a kind of elegance that doesn’t need permission.",
        "Your mind is sharp, but your heart is careful. That balance is extraordinary.",
        "You deserve softness, space, and a year that treats you well.",
        "You turn ordinary moments into something considered—simply by being there."
      ]);

      // Cycling without mutation: function returns next index
      /** @type {(len:number)=>()=>number} */
      const makeCycler = (len) => {
        let i = 0;
        return () => (i = (i + 1) % len);
      };
      const nextIndex = makeCycler(lines.length);

      let w = 1, h = 1, dpr = 1;

      // Precomputed points (deterministic but “natural”)
      const count = 18;
      const px = new Float32Array(count);
      const py = new Float32Array(count);
      const pv = new Float32Array(count);

      /** @type {()=>void} */
      const reseed = () => {
        for (let i = 0; i < count; i++){
          px[i] = (0.08 + rng() * 0.84);
          py[i] = (0.10 + rng() * 0.80);
          pv[i] = 0.4 + rng() * 0.6;
        }
      };
      reseed();

      /** @type {(W:number,H:number)=>void} */
      const resize = (W, H) => {
        w = Math.max(1, Math.floor(W));
        h = Math.max(1, Math.floor(H));
        dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
        canvas.width = Math.floor(w * dpr);
        canvas.height = Math.floor(h * dpr);
        canvas.style.width = w + 'px';
        canvas.style.height = h + 'px';
      };

      /** @type {(t:number)=>void} */
      const draw = (t) => {
        ctx.save();
        ctx.setTransform(dpr, 0, 0, dpr, 0, 0);

        ctx.clearRect(0, 0, w, h);

        // background glow
        const g = ctx.createRadialGradient(w*0.35, h*0.25, 30, w*0.35, h*0.25, Math.max(w,h));
        g.addColorStop(0, 'rgba(0,242,255,.07)');
        g.addColorStop(0.5, 'rgba(123,44,191,.04)');
        g.addColorStop(1, 'rgba(0,0,0,0)');
        ctx.fillStyle = g;
        ctx.fillRect(0, 0, w, h);

        // connect near neighbors (O(n^2) with n=18 is tiny; stable and simple)
        ctx.lineWidth = 1;
        for (let i = 0; i < count; i++){
          const xi = px[i] * w;
          const yi = py[i] * h;

          for (let j = i + 1; j < count; j++){
            const xj = px[j] * w;
            const yj = py[j] * h;
            const dx = xi - xj, dy = yi - yj;
            const d2 = dx*dx + dy*dy;
            const maxD2 = (Math.min(w,h) * 0.26) ** 2;
            if (d2 > maxD2) continue;

            const a = 1 - (d2 / maxD2);
            ctx.strokeStyle = `rgba(0,242,255,${0.05 + a*0.10})`;
            ctx.beginPath();
            ctx.moveTo(xi, yi);
            ctx.lineTo(xj, yj);
            ctx.stroke();
          }
        }

        // stars
        for (let i = 0; i < count; i++){
          const x = px[i] * w;
          const y = py[i] * h;
          const pulse = 0.55 + 0.45 * Math.sin((t * 0.002) + i * 0.7);
          const r = 1.2 + 1.8 * pv[i] * pulse;

          ctx.fillStyle = `rgba(255,255,255,${0.55 + 0.35*pulse})`;
          ctx.beginPath();
          ctx.arc(x, y, r, 0, Math.PI * 2);
          ctx.fill();

          ctx.fillStyle = `rgba(0,242,255,${0.10 + 0.10*pulse})`;
          ctx.beginPath();
          ctx.arc(x, y, r * 2.4, 0, Math.PI * 2);
          ctx.fill();
        }

        ctx.restore();
        requestAnimationFrame(draw);
      };

      // Click reveals the next line (no invented memories).
      /** @type {(e:MouseEvent)=>void} */
      const onClick = () => {
        const idx = nextIndex();
        quoteEl.textContent = lines[idx];
      };

      const ro = new ResizeObserver(() => {
        const rect = canvas.getBoundingClientRect();
        resize(rect.width, rect.height);
      });
      ro.observe(canvas);

      canvas.addEventListener('click', onClick);

      requestAnimationFrame(draw);

      // cleanup function
      return () => {
        ro.disconnect();
        canvas.removeEventListener('click', onClick);
      };
    };

    // ---------------------------
    // App init (structured; no races)
    // ---------------------------
    const boot = $('#boot');
    const bootTitle = $('#bootTitle');
    const progBar = $('#progBar');
    const progText = $('#progText');
    const assetText = $('#assetText');
    const enterBtn = /** @type {HTMLButtonElement} */ ($('#enterBtn'));
    const muteBtn = /** @type {HTMLButtonElement} */ ($('#muteBtn'));

    const app = $('#app');
    const nameSlot = $('#nameSlot');

    const bgCanvas = /** @type {HTMLCanvasElement} */ ($('#universe'));
    const bgCtx = bgCanvas.getContext('2d');

    const audio = /** @type {HTMLAudioElement} */ ($('#bgm'));
    const playBtn = /** @type {HTMLButtonElement} */ ($('#playBtn'));
    const vol = /** @type {HTMLInputElement} */ ($('#vol'));
    const seek = /** @type {HTMLInputElement} */ ($('#seek'));
    const tNow = $('#tNow');
    const tEnd = $('#tEnd');
    const vizEl = $('#viz');

    const gallery = $('#gallery');
    const lightbox = /** @type {HTMLDialogElement} */ ($('#lightbox'));
    const lbImg = /** @type {HTMLImageElement} */ ($('#lbImg'));
    const lbTitle = $('#lbTitle');
    const lbMeta = $('#lbMeta');
    const lbClose = /** @type {HTMLButtonElement} */ ($('#lbClose'));

    const constellationCanvas = /** @type {HTMLCanvasElement} */ ($('#constellationCanvas'));
    const quoteEl = $('#quote');

    const images = freeze([
      { id: 'K1', src: 'K1.png', label: 'Portrait' },
      { id: 'K2', src: 'K2.png', label: 'Light' },
      { id: 'K3', src: 'K3.png', label: 'Stillness' },
    ]);

    // Name from query string (no assumptions)
    const qs = new URLSearchParams(location.search);
    const rawName = (qs.get('name') ?? 'my love').trim();
    const safeName = rawName.length > 0 ? rawName.slice(0, 42) : 'my love';
    nameSlot.textContent = safeName;

    // Deterministic seed based on name (stable “memory feel”)
    const rng = mulberry32(fnv1a32(safeName.toLowerCase() + '|birthday'));

    // Global error logging (no crash guarantee; we only log)
    window.addEventListener('error', (e) => log.err('Runtime error:', e.error ?? e.message));
    window.addEventListener('unhandledrejection', (e) => log.err('Unhandled promise rejection:', e.reason));

    // Canvas resize
    /** @type {()=>{w:number,h:number,dpr:number}} */
    const fitBg = () => {
      const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
      const w = Math.max(1, window.innerWidth);
      const h = Math.max(1, window.innerHeight);
      bgCanvas.width = Math.floor(w * dpr);
      bgCanvas.height = Math.floor(h * dpr);
      bgCanvas.style.width = w + 'px';
      bgCanvas.style.height = h + 'px';
      return { w, h, dpr };
    };

    const canDrawBg = !!bgCtx;
    const starfield = makeStarfield(720, rng);

    /** @type {()=>void} */
    const startBackground = () => {
      if (!bgCtx) return;
      let last = performance.now();

      const onResize = () => {
        const { w, h, dpr } = fitBg();
        starfield.resize(w, h, dpr);
      };
      window.addEventListener('resize', onResize, { passive: true });
      onResize();

      /** @type {(now:number)=>void} */
      const loop = (now) => {
        const dt = clamp((now - last) / 1000, 0, 0.05);
        last = now;
        starfield.tick(dt);
        starfield.draw(bgCtx);
        requestAnimationFrame(loop);
      };
      requestAnimationFrame(loop);
    };

    // Reveal on scroll (lazy + breathing space)
    /** @type {()=>void} */
    const initReveal = () => {
      const nodes = $$('.reveal');
      if (!('IntersectionObserver' in window)){
        nodes.forEach(n => n.classList.add('in'));
        return;
      }
      const io = new IntersectionObserver((entries) => {
        entries.forEach(en => {
          if (en.isIntersecting){
            en.target.classList.add('in');
            io.unobserve(en.target);
          }
        });
      }, { threshold: 0.12 });
      nodes.forEach(n => io.observe(n));
    };

    // Gallery error fallback
    const bindImgFallback = () => {
      const pairs = [
        ['#imgK1', 0],
        ['#imgK2', 1],
        ['#imgK3', 2],
      ];
      pairs.forEach(([sel]) => {
        const el = /** @type {HTMLImageElement|null} */ (document.querySelector(sel));
        if (!el) return;
        el.addEventListener('error', () => {
          const fig = el.closest('figure');
          if (fig) fig.classList.add('broken');
          log.warn('Image failed to load:', el.src);
        }, { once: true });
      });
    };

    // Lightbox (complete feature: click, esc, arrows)
    /** @type {{idx:number}} */
    let lbState = { idx: 0 };

    /** @type {(i:number)=>void} */
    const openLightbox = (i) => {
      const item = images[i];
      if (!item) return;
      lbState = { idx: i };
      lbTitle.textContent = 'Fragment ' + (i + 1);
      lbMeta.textContent = item.label.toUpperCase();
      lbImg.src = item.src;
      lbImg.alt = item.label;

      // If image missing, dialog still opens but shows broken image icon; log only.
      try { lightbox.showModal(); } catch { /* ignore */ }
    };

    /** @type {(dir:-1|1)=>void} */
    const navLightbox = (dir) => {
      const n = images.length;
      const next = (lbState.idx + dir + n) % n;
      openLightbox(next);
    };

    // Audio player
    const bars = initBars(vizEl, 34);

    /** @type {{ctx?:AudioContext, analyser?:AnalyserNode, data?:Uint8Array, raf?:number}} */
    let audioFx = {};

    /** @type {()=>void} */
    const stopViz = () => {
      if (audioFx.raf) cancelAnimationFrame(audioFx.raf);
      audioFx.raf = undefined;
    };

    /** @type {()=>void} */
    const startViz = () => {
      stopViz();
      // fallback animation if analyser unavailable
      const fallback = () => {
        const t = performance.now() * 0.004;
        for (let i = 0; i < bars.length; i++){
          const v = 0.55 + 0.45 * Math.sin(t + i * 0.45);
          bars[i].style.height = (8 + Math.round(v * 34)) + 'px';
        }
        audioFx.raf = requestAnimationFrame(fallback);
      };

      if (!audioFx.analyser || !audioFx.data){
        fallback();
        return;
      }

      const { analyser, data } = audioFx;

      /** @type {()=>void} */
      const frame = () => {
        try{
          analyser.getByteFrequencyData(data);
          paintBars(bars, data);
          audioFx.raf = requestAnimationFrame(frame);
        } catch (e){
          log.warn('Visualizer failed; falling back.', e);
          audioFx.analyser = undefined;
          audioFx.data = undefined;
          fallback();
        }
      };
      audioFx.raf = requestAnimationFrame(frame);
    };

    /** @type {()=>Promise<void>} */
    const ensureAudioGraph = async () => {
      if (audioFx.ctx && audioFx.analyser) return;

      try{
        const Ctx = window.AudioContext || window.webkitAudioContext;
        if (!Ctx) { log.warn('AudioContext not supported.'); return; }

        const ctx = new Ctx();
        const src = ctx.createMediaElementSource(audio);
        const analyser = ctx.createAnalyser();
        analyser.fftSize = 64;

        src.connect(analyser);
        analyser.connect(ctx.destination);

        audioFx = { ctx, analyser, data: new Uint8Array(analyser.frequencyBinCount) };
      } catch (e){
        log.warn('Audio graph init failed:', e);
      }
    };

    /** @type {()=>void} */
    const syncTimeUI = () => {
      const dur = Number.isFinite(audio.duration) ? audio.duration : 0;
      const cur = Number.isFinite(audio.currentTime) ? audio.currentTime : 0;

      tNow.textContent = fmtTime(cur);
      tEnd.textContent = dur > 0 ? fmtTime(dur) : '--:--';

      if (dur > 0){
        const v = Math.round((cur / dur) * 1000);
        if (!Number.isNaN(v)) seek.value = String(v);
      }
    };

    // Preflight assets before enabling entry
    /** @type {Asset[]} */
    const assets = freeze([
      { id: 'K1.png', kind: 'image', src: 'K1.png' },
      { id: 'K2.png', kind: 'image', src: 'K2.png' },
      { id: 'K3.png', kind: 'image', src: 'K3.png' },
      { id: 'fallen-down.mp3', kind: 'audio', src: 'fallen-down.mp3' },
    ]);

    /** @type {()=>Promise<AssetResult[]>} */
    const preflight = async () => {
      const total = assets.length;
      let done = 0;

      /** @type {(msg:string)=>void} */
      const setStatus = (msg) => { progText.textContent = msg; };

      /** @type {(d:number)=>void} */
      const setProgress = (d) => {
        const p = clamp(d / total, 0, 1);
        progBar.style.width = (p * 100).toFixed(1) + '%';
        assetText.textContent = `${d}/${total}`;
      };

      setStatus('Loading assets…');
      setProgress(0);

      const tasks = assets.map((a) => (async () => {
        const r = a.kind === 'image'
          ? await loadImage(a.src)
          : await loadAudio(audio);

        done += 1;
        setProgress(done);

        if (!r.ok) log.warn('Asset failed:', a.src, r.error);
        else log.info('Asset ok:', a.src, (r.ms | 0) + 'ms');

        return /** @type {AssetResult} */ ({ id: a.id, ok: r.ok, ms: r.ms, error: r.error });
      })());

      // Never throw: we want “all settled” behavior.
      const res = await Promise.allSettled(tasks);
      const flat = res.map((x) => x.status === 'fulfilled'
        ? x.value
        : ({ id: 'unknown', ok: false, ms: 0, error: x.reason })
      );

      setStatus('Ready.');
      return flat;
    };

    // Boot orchestration
    const run = async () => {
      // Start background immediately (cheap + atmospheric)
      if (canDrawBg) startBackground();

      // Faster initial boot text (not slow/bloated)
      scrambleTo(bootTitle, 'HAPPY BIRTHDAY', 520, rng).catch(() => {});

      // Preflight assets (does not crash on failure)
      const results = await preflight();

      // Enable entry regardless; but reflect failures in console
      const okCount = results.filter(r => r.ok).length;
      const failCount = results.length - okCount;
      if (failCount > 0) log.warn(`Preflight complete with ${failCount} failure(s). Page will degrade gracefully.`);
      enterBtn.disabled = false;

      // Small pause to feel intentional (not “slow loading”)
      await sleep(120);

      // Gentle secondary title pass (adds “memory” feel; still fast)
      scrambleTo(bootTitle, `FOR ${safeName.toUpperCase()}`, 620, rng).catch(() => {});
    };

    // Entry: reveal app; optionally start music
    /** @type {(opts:{play:boolean})=>Promise<void>} */
    const enter = async ({ play }) => {
      boot.classList.add('hidden');
      app.classList.add('visible');
      app.setAttribute('aria-hidden', 'false');

      initReveal();
      bindImgFallback();

      // Lazy constellation init (only when section appears)
      let cleanupConstellation = () => {};
      if ('IntersectionObserver' in window){
        const section = constellationCanvas.closest('section') || constellationCanvas;
        const io = new IntersectionObserver((entries) => {
          entries.forEach(en => {
            if (!en.isIntersecting) return;
            cleanupConstellation = makeConstellation(constellationCanvas, quoteEl, rng);
            io.disconnect();
          });
        }, { threshold: 0.18 });
        io.observe(section);
      } else {
        cleanupConstellation = makeConstellation(constellationCanvas, quoteEl, rng);
      }

      // Audio setup (never blocks UI)
      vol.addEventListener('input', () => { audio.volume = clamp(Number(vol.value), 0, 1); }, { passive: true });
      audio.volume = clamp(Number(vol.value), 0, 1);

      audio.addEventListener('timeupdate', syncTimeUI, { passive: true });
      audio.addEventListener('loadedmetadata', syncTimeUI, { passive: true });

      seek.addEventListener('input', () => {
        const dur = Number.isFinite(audio.duration) ? audio.duration : 0;
        if (dur <= 0) return;
        const v = clamp(Number(seek.value) / 1000, 0, 1);
        audio.currentTime = v * dur;
      }, { passive: true });

      playBtn.addEventListener('click', async () => {
        if (audio.paused){
          await ensureAudioGraph();
          try{
            await audio.play();
            playBtn.textContent = 'Pause';
            startViz();
          } catch (e){
            log.warn('Audio play blocked:', e);
          }
        } else {
          audio.pause();
          playBtn.textContent = 'Play';
          startViz(); // keep soft motion even paused
        }
      });

      // Start silent visualizer motion by default
      startViz();
      syncTimeUI();

      if (play){
        // user gesture already occurred; safe to attempt
        await ensureAudioGraph();
        try{
          await audio.play();
          playBtn.textContent = 'Pause';
          startViz();
        } catch (e){
          log.warn('Audio autoplay blocked (expected on some browsers):', e);
        }
      }

      // Gallery click delegation
      gallery.addEventListener('click', (e) => {
        const fig = /** @type {HTMLElement|null} */ ((/** @type {HTMLElement} */(e.target)).closest('figure[data-idx]'));
        if (!fig || fig.classList.contains('broken')) return;
        const idx = Number(fig.getAttribute('data-idx') || '0');
        openLightbox(idx);
      });

      // Lightbox handlers
      lbClose.addEventListener('click', () => lightbox.close());
      lightbox.addEventListener('click', (e) => {
        const rect = lbImg.getBoundingClientRect();
        // click outside image closes
        const x = /** @type {MouseEvent} */ (e).clientX;
        const y = /** @type {MouseEvent} */ (e).clientY;
        const inside = (x >= rect.left && x <= rect.right && y >= rect.top && y <= rect.bottom);
        if (!inside) lightbox.close();
      });

      window.addEventListener('keydown', (e) => {
        if (!lightbox.open) return;
        if (e.key === 'Escape') lightbox.close();
        if (e.key === 'ArrowLeft') navLightbox(-1);
        if (e.key === 'ArrowRight') navLightbox(1);
      });

      // If page gets hidden, pause audio to be polite
      document.addEventListener('visibilitychange', () => {
        if (document.hidden && !audio.paused){
          audio.pause();
          playBtn.textContent = 'Play';
        }
      }, { passive: true });
    };

    // Boot buttons
    enterBtn.addEventListener('click', () => enter({ play: true }));
    muteBtn.addEventListener('click', () => enter({ play: false }));

    // Kick it off
    run().catch((e) => {
      log.err('Boot failed unexpectedly:', e);
      // Even if boot orchestration fails, allow entry.
      enterBtn.disabled = false;
    });
  </script>
</body>
</html>
