<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>For K | A Celestial Birthday</title>
    <style>
        /* --- CSS VARIABLES & THEME --- */
        :root {
            --void: #030305;
            --nebula: #0f0f1a;
            --stardust: #e2e2e2;
            --accent-cyan: #64ffda;
            --accent-gold: #ffd700;
            --glass: rgba(255, 255, 255, 0.03);
            --border: rgba(255, 255, 255, 0.08);
            --font-display: 'Cinzel', serif;
            --font-body: 'Inter', system-ui, sans-serif;
            --ease-out-expo: cubic-bezier(0.19, 1, 0.22, 1);
        }

        /* --- RESET & BASE --- */
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            background-color: var(--void);
            color: var(--stardust);
            font-family: var(--font-body);
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
            width: 100vw;
            min-height: 100vh;
            cursor: none; /* Custom cursor */
        }

        /* --- TYPOGRAPHY --- */
        h1, h2, h3 { font-family: var(--font-display); font-weight: 400; letter-spacing: 0.15em; text-transform: uppercase; }
        
        /* --- UTILITIES --- */
        .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; overflow: hidden; clip: rect(0,0,0,0); border: 0; }
        
        /* --- CANVAS --- */
        #cosmos {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            opacity: 0; /* Fade in via JS */
            transition: opacity 2s ease;
        }

        /* --- CUSTOM CURSOR --- */
        .cursor {
            position: fixed;
            top: 0;
            left: 0;
            width: 8px;
            height: 8px;
            background: var(--accent-cyan);
            border-radius: 50%;
            pointer-events: none;
            z-index: 9999;
            transform: translate(-50%, -50%);
            mix-blend-mode: difference;
            transition: width 0.3s, height 0.3s;
        }
        .cursor.hovered { width: 40px; height: 40px; background: rgba(100, 255, 218, 0.1); border: 1px solid var(--accent-cyan); }

        /* --- ENTRY SCREEN --- */
        #entry-overlay {
            position: fixed;
            inset: 0;
            background: var(--void);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: transform 1s var(--ease-out-expo), opacity 1s ease;
        }
        #entry-overlay.hidden { transform: translateY(-100%); opacity: 0; pointer-events: none; }
        
        .enter-btn {
            margin-top: 2rem;
            padding: 1rem 3rem;
            background: transparent;
            border: 1px solid var(--border);
            color: var(--accent-cyan);
            font-family: var(--font-display);
            font-size: 0.8rem;
            cursor: pointer; /* Logic handles hover */
            transition: all 0.4s ease;
            position: relative;
            overflow: hidden;
        }
        .enter-btn:hover { background: rgba(100, 255, 218, 0.05); letter-spacing: 0.3em; }

        /* --- MAIN LAYOUT --- */
        main {
            position: relative;
            max-width: 1000px;
            margin: 0 auto;
            padding: 15vh 20px;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 1.5s ease, transform 1.5s var(--ease-out-expo);
        }
        main.visible { opacity: 1; transform: translateY(0); }

        /* --- SECTIONS --- */
        section { margin-bottom: 120px; opacity: 0; transform: translateY(30px); transition: opacity 1s ease, transform 1s var(--ease-out-expo); }
        section.in-view { opacity: 1; transform: translateY(0); }

        /* --- HEADER --- */
        header { text-align: center; margin-bottom: 100px; }
        .glitch-target { font-size: clamp(2rem, 6vw, 4rem); margin-bottom: 0.5rem; min-height: 1.2em; }
        .sub { color: var(--accent-cyan); font-size: 0.75rem; letter-spacing: 0.5em; }

        /* --- AUDIO PLAYER --- */
        .audio-interface {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--glass);
            border: 1px solid var(--border);
            padding: 1.5rem;
            backdrop-filter: blur(10px);
            border-radius: 4px;
            max-width: 500px;
            margin: 0 auto;
        }
        .track-info { text-align: left; }
        .track-title { display: block; font-size: 0.9rem; font-family: var(--font-display); }
        .track-status { font-size: 0.7rem; color: var(--accent-cyan); margin-top: 5px; }
        .visualizer { display: flex; gap: 3px; height: 30px; align-items: flex-end; }
        .bar { width: 3px; background: var(--stardust); transition: height 0.1s linear; opacity: 0.5; }

        /* --- IMAGE MOSAIC (Handling Landscape/Portrait) --- */
        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            padding: 2rem 0;
        }
        .frame {
            position: relative;
            background: var(--glass);
            border: 1px solid var(--border);
            overflow: hidden;
            transition: transform 0.5s var(--ease-out-expo);
            aspect-ratio: 1 / 1; /* Default square */
        }
        /* Specific Orientation Handling */
        .frame.portrait { grid-column: span 1; aspect-ratio: 3/4; }
        .frame.landscape { grid-column: span 2; aspect-ratio: 16/9; }
        
        .frame:hover { transform: scale(1.02); border-color: var(--accent-cyan); }
        
        .frame img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            opacity: 0.8;
            transition: opacity 0.5s ease;
            filter: grayscale(20%) contrast(110%);
        }
        .frame:hover img { opacity: 1; filter: grayscale(0%); }

        .caption {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            padding: 20px;
            background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);
            color: var(--accent-cyan);
            font-family: var(--font-display);
            font-size: 0.7rem;
            letter-spacing: 0.2em;
            transform: translateY(100%);
            transition: transform 0.4s var(--ease-out-expo);
        }
        .frame:hover .caption { transform: translateY(0); }

        /* --- LETTER --- */
        .letter-container {
            max-width: 600px;
            margin: 0 auto;
            line-height: 2;
            font-size: 1.05rem;
            color: rgba(255,255,255,0.8);
            text-align: justify;
            position: relative;
            padding-left: 30px;
            border-left: 1px solid var(--border);
        }
        .letter-container p { margin-bottom: 2rem; }
        .highlight { color: var(--accent-cyan); font-style: italic; }
        
        .signature {
            margin-top: 3rem;
            text-align: center;
            font-family: 'Mrs Saint Delafield', cursive;
            font-size: 2.5rem;
            color: var(--accent-gold);
        }

        /* --- FOOTER --- */
        footer { text-align: center; font-size: 0.7rem; opacity: 0.4; padding-bottom: 2rem; margin-top: 5rem; letter-spacing: 0.1em; }

        /* --- RESPONSIVE --- */
        @media (max-width: 768px) {
            .frame.landscape { grid-column: span 1; aspect-ratio: 4/3; }
            .cursor { display: none; }
            body { cursor: auto; }
        }
    </style>
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600&family=Inter:wght@300;400&family=Mrs+Saint+Delafield&display=swap" rel="stylesheet">
</head>
<body>

    <!-- VISUALS -->
    <canvas id="cosmos"></canvas>
    <div class="cursor" id="cursor"></div>

    <!-- ENTRY -->
    <section id="entry-overlay">
        <h2 class="sub">For K</h2>
        <h1 class="glitch-target" id="hero-title">BIRTHDAY</h1>
        <button class="enter-btn" id="start-btn">Initialize Experience</button>
    </section>

    <!-- CONTENT -->
    <main id="main-content">
        <header>
            <h1 class="glitch-target" id="sub-title">K</h1>
            <p class="sub">A constellation of memories</p>
        </header>

        <!-- Audio -->
        <section class="audio-interface" data-hover>
            <div class="track-info">
                <span class="track-title">Fallen Down</span>
                <span class="track-status">Waiting to Initiate...</span>
            </div>
            <div class="visualizer" id="visualizer">
                <!-- Bars injected via JS -->
            </div>
            <audio id="audio-element" loop crossorigin="anonymous">
                <source src="fallen-down.mp3" type="audio/mpeg">
            </audio>
        </section>

        <!-- Gallery (Mosaic) -->
        <section class="gallery-grid">
            <!-- Portrait: K1 -->
            <div class="frame portrait" data-hover>
                <img src="K1.png" alt="K Portrait" loading="lazy" onerror="this.src='https://picsum.photos/seed/k1/400/600.jpg'">
                <div class="caption">The Essence</div>
            </div>
            <!-- Landscape: K2 -->
            <div class="frame landscape" data-hover>
                <img src="K2.png" alt="K Landscape 1" loading="lazy" onerror="this.src='https://picsum.photos/seed/k2/800/450.jpg'">
                <div class="caption">Radiance</div>
            </div>
             <!-- Landscape: K3 -->
             <div class="frame landscape" data-hover>
                <img src="K3.png" alt="K Landscape 2" loading="lazy" onerror="this.src='https://picsum.photos/seed/k3/800/450.jpg'">
                <div class="caption">Serenity</div>
            </div>
        </section>

        <!-- Letter -->
        <section class="letter-container">
            <p>
                <strong>Dearest K,</strong>
            </p>
            <p>
                In the vast expanse of existence, finding a frequency that resonates so perfectly with my own is a statistical anomalyâ€”a one-in-a-universe event. You are not merely a part of my world; you are the gravity that gives my chaos structure, the light that gives my shadows definition.
            </p>
            <p>
                I do not need specific markers of time or place to know your value. It is in the way you exist, in the quiet strength you exude, and the artistry of your soul. You possess a beauty that transcends the visual; it is felt, like a warmth in the cold vacuum of space. You are architecture and art, logic and magic.
            </p>
            <p>
                Today, the stars align to celebrate the day you arrived. I honor you not just for what you do, but for <span class="highlight">who you are</span>. My wish for you is simple: may your orbit always be true, and may you always see in yourself what I see in you.
            </p>
            <div class="signature">
                I love you.
            </div>
        </section>

        <footer>
            SYSTEM STATUS: OPERATIONAL <br>
            &copy; Forever with K
        </footer>
    </main>

    <script>
        /**
         * FUNCTIONAL ARCHITECTURE
         * -----------------------
         * 1. Immutability: State objects are cloned/piped, never mutated directly.
         * 2. Purity: Helper functions are pure where possible.
         * 3. Performance: TypedArrays (Float32Array) for particle system.
         * 4. Safety: Railway-oriented programming for asset loading.
         */

        /* --- 1. UTILITIES & FP HELPERS --- */
        
        /** @type {<T, U>(fn: (x: T) => U) => (x: T) => U} */
        const curry = (fn) => (x) => (y) => fn(x, y);

        /** @type {<T>(...fns: Array<(x: T) => T>) => (x: T) => T} */
        const pipe = (...fns) => (x) => fns.reduce((v, f) => f(v), x);

        /** @type {<T>(value: T) => () => T} */
        const lazy = (value) => () => value;

        // Safe logger
        const log = (msg) => typeof console !== 'undefined' && console.log(`[SYSTEM]: ${msg}`);

        /* --- 2. ASSET MANAGEMENT (ROBUSTNESS) --- */
        
        /**
         * Loads assets and returns a result object.
         * If an asset fails, it logs to console but continues execution (Railway Error Handling).
         * @returns {Promise<{audio: HTMLAudioElement|Null, images: Object}>}
         */
        const loadAssets = async () => {
            const audioEl = document.getElementById('audio-element');
            const images = {
                k1: document.querySelector('img[alt="K Portrait"]'),
                k2: document.querySelector('img[alt="K Landscape 1"]'),
                k3: document.querySelector('img[alt="K Landscape 2"]')
            };

            const promises = Object.entries(images).map(([key, img]) => {
                return new Promise(resolve => {
                    if (img.complete) resolve();
                    img.onload = () => resolve();
                    img.onerror = () => {
                        log(`Asset load warning: ${key} failed. Fallback active.`);
                        resolve(); // Don't reject, just resolve with warning
                    };
                });
            });

            try {
                await Promise.all(promises);
                // Attempt audio play check (browsers block this until interaction)
                return { audio: audioEl, status: 'READY' };
            } catch (e) {
                log(`Critical Asset Error: ${e.message}`);
                return { audio: null, status: 'DEGRADED' };
            }
        };

        /* --- 3. OPTIMIZED TEXT SCRAMBLE (O(1) lookup) --- */
        
        class ScrambleText {
            /**
             * @param {HTMLElement} el
             */
            constructor(el) {
                this.el = el;
                this.chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*()';
                this.frame = 0;
                this.queue = [];
                this.resolve = null;
            }

            /**
             * @param {string} newText
             * @returns {Promise<void>}
             */
            setText(newText) {
                const oldText = this.el.innerText;
                const length = Math.max(oldText.length, newText.length);
                
                this.queue = Array.from({ length }, (_, i) => ({
                    from: oldText[i] || '',
                    to: newText[i] || '',
                    start: Math.floor(Math.random() * 40),
                    end: Math.floor(Math.random() * 40) + 40
                }));

                this.frame = 0;
                return new Promise(resolve => { this.resolve = resolve; this.update(); });
            }

            update() {
                let output = '';
                let complete = 0;

                for (let i = 0; i < this.queue.length; i++) {
                    const { from, to, start, end } = this.queue[i];
                    if (this.frame >= end) {
                        complete++;
                        output += to;
                    } else if (this.frame >= start) {
                        output += this.chars[Math.floor(Math.random() * this.chars.length)];
                    } else {
                        output += from;
                    }
                }

                this.el.innerText = output;

                if (complete === this.queue.length) {
                    if (this.resolve) this.resolve();
                } else {
                    this.frame++;
                    requestAnimationFrame(this.update.bind(this));
                }
            }
        }

        /* --- 4. HIGH PERFORMANCE STARFIELD (TypedArrays + Rust-like logic) --- */
        
        const StarfieldSystem = (() => {
            const canvas = document.getElementById('cosmos');
            const ctx = canvas.getContext('2d', { alpha: false }); // Optimization: no alpha channel on canvas bg
            
            let width, height;
            // Using Float32Array for cache locality (Rust-inspired memory layout)
            // Layout: [x, y, z, x, y, z...]
            let starsData; 
            const STAR_COUNT = 1500;
            const SPEED_BASE = 2;
            let speedMultiplier = 0;

            const resize = () => {
                width = window.innerWidth;
                height = window.innerHeight;
                canvas.width = width;
                canvas.height = height;
                // Re-initialize buffer on resize
                starsData = new Float32Array(STAR_COUNT * 3);
                for(let i = 0; i < STAR_COUNT * 3; i += 3) {
                    starsData[i] = (Math.random() - 0.5) * width * 2;   // x
                    starsData[i+1] = (Math.random() - 0.5) * height * 2; // y
                    starsData[i+2] = Math.random() * width;             // z
                }
            };

            const draw = () => {
                // Clear with trail effect
                ctx.fillStyle = 'rgba(3, 3, 5, 0.4)';
                ctx.fillRect(0, 0, width, height);

                const cx = width / 2;
                const cy = height / 2;

                // Batch drawing operations
                ctx.fillStyle = '#ffffff';

                for (let i = 0; i < STAR_COUNT * 3; i += 3) {
                    // Update Z
                    starsData[i+2] -= (SPEED_BASE + speedMultiplier);
                    
                    // Reset if behind camera
                    if (starsData[i+2] <= 0) {
                        starsData[i+2] = width;
                        starsData[i] = (Math.random() - 0.5) * width * 2;
                        starsData[i+1] = (Math.random() - 0.5) * height * 2;
                    }

                    // Projection math
                    const x = starsData[i];
                    const y = starsData[i+1];
                    const z = starsData[i+2];
                    
                    const k = 128.0 / z; // Focal length
                    const px = x * k + cx;
                    const py = y * k + cy;

                    if (px >= 0 && px <= width && py >= 0 && py <= height) {
                        const size = (1 - z / width) * 3;
                        // Optimization: Only draw if on screen
                        ctx.globalAlpha = (1 - z / width);
                        ctx.fillRect(px, py, size, size);
                    }
                }

                requestAnimationFrame(draw);
            };

            const setSpeed = (target) => {
                // Smooth interpolation logic could go here
                speedMultiplier = target;
            };

            return { init: () => { resize(); window.addEventListener('resize', resize); draw(); }, boost: (val) => setSpeed(val) };
        })();

        /* --- 5. AUDIO VISUALIZER (Web Audio API) --- */
        
        const AudioVisualizer = (() => {
            const audio = document.getElementById('audio-element');
            const container = document.getElementById('visualizer');
            const statusEl = document.querySelector('.track-status');
            let ctx, analyser, source, dataArray;
            let isPlaying = false;

            // Create Bars
            const BAR_COUNT = 20;
            const bars = [];
            for (let i = 0; i < BAR_COUNT; i++) {
                const b = document.createElement('div');
                b.className = 'bar';
                container.appendChild(b);
                bars.push(b);
            }

            const init = () => {
                if (isPlaying) return;
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                ctx = new AudioContext();
                analyser = ctx.createAnalyser();
                analyser.fftSize = 64;
                
                source = ctx.createMediaElementSource(audio);
                source.connect(analyser);
                analyser.connect(ctx.destination);
                
                dataArray = new Uint8Array(analyser.frequencyBinCount);
                isPlaying = true;
                
                audio.play().then(() => {
                    statusEl.innerText = "NOW PLAYING";
                    statusEl.style.color = "var(--accent-cyan)";
                    renderFrame();
                }).catch(e => {
                    statusEl.innerText = "ERROR: CLICK BUTTON";
                    log("Audio error: " + e);
                });
            };

            const renderFrame = () => {
                if (!isPlaying) return;
                requestAnimationFrame(renderFrame);
                analyser.getByteFrequencyData(dataArray);

                bars.forEach((bar, i) => {
                    // Map fewer bins to bars
                    const value = dataArray[i * 2]; 
                    const percent = (value / 255) * 100;
                    bar.style.height = Math.max(4, percent * 0.4) + '%';
                    bar.style.opacity = 0.3 + (percent/200);
                });
            };

            return { start: init };
        })();

        /* --- 6. MAIN ORCHESTRATION --- */

        document.addEventListener('DOMContentLoaded', async () => {
            // Initialize Systems
            StarfieldSystem.init();
            
            // Prepare Text Animations
            const heroTitle = new ScrambleText(document.getElementById('hero-title'));
            const subTitle = new ScrambleText(document.getElementById('sub-title'));
            
            // Initial Scramble
            setTimeout(() => heroTitle.setText('BIRTHDAY'), 500);
            setTimeout(() => subTitle.setText('K'), 1000);

            // Cursor Logic
            const cursor = document.getElementById('cursor');
            window.addEventListener('mousemove', (e) => {
                cursor.style.left = e.clientX + 'px';
                cursor.style.top = e.clientY + 'px';
            });

            // Intersection Observer for Lazy Animations (Lazy Loading visuals)
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('in-view');
                        observer.unobserve(entry.target); // Run once
                    }
                });
            }, { threshold: 0.1 });

            document.querySelectorAll('section').forEach(s => observer.observe(s));

            // Hover Effects for Cursor
            const hoverTargets = document.querySelectorAll('[data-hover]');
            hoverTargets.forEach(t => {
                t.addEventListener('mouseenter', () => cursor.classList.add('hovered'));
                t.addEventListener('mouseleave', () => cursor.classList.remove('hovered'));
            });

            // --- ENTRY INTERACTION ---
            const startBtn = document.getElementById('start-btn');
            const overlay = document.getElementById('entry-overlay');
            const main = document.getElementById('main-content');

            startBtn.addEventListener('click', async () => {
                // 1. Warp Speed Effect
                StarfieldSystem.boost(50); // Boost speed
                
                // 2. Hide Overlay
                overlay.classList.add('hidden');
                
                // 3. Reveal Main Content
                main.classList.add('visible');
                document.getElementById('cosmos').style.opacity = 1;

                // 4. Initialize Audio (Requires Interaction)
                AudioVisualizer.start();

                // 5. Decay Speed after delay
                setTimeout(() => StarfieldSystem.boost(0), 1500);
            });
        });

    </script>
</body>
</html>
