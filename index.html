<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Happy Birthday | A Memory in Stars</title>
    <style>
        :root {
            --void: #020204;
            --deep-space: #08080f;
            --starlight: #e4e6f2;
            --nebula-core: #5a1f99;
            --gravity-cyan: #00d4ff;
            --warm-gold: #ffc940;
            --soft-blush: #ff7eb3;
            --text-dim: rgba(228, 230, 242, 0.6);
        }

        *, *::before, *::after {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            background: var(--void);
            color: var(--starlight);
            font-family: 'Cormorant Garamond', 'Times New Roman', serif;
            min-height: 100vh;
            overflow-x: hidden;
            line-height: 1.7;
            cursor: none;
        }

        /* Custom Cursor */
        .cursor-glow {
            position: fixed;
            width: 8px;
            height: 8px;
            background: var(--starlight);
            border-radius: 50%;
            pointer-events: none;
            z-index: 10000;
            transform: translate(-50%, -50%);
            transition: transform 0.1s ease;
            box-shadow: 0 0 20px rgba(0, 212, 255, 0.5);
        }

        .cursor-ring {
            position: fixed;
            width: 40px;
            height: 40px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            pointer-events: none;
            z-index: 9999;
            transform: translate(-50%, -50%);
            transition: width 0.3s, height 0.3s, border-color 0.3s;
        }

        .cursor-ring.expanded {
            width: 60px;
            height: 60px;
            border-color: var(--gravity-cyan);
        }

        /* Cosmos Canvas */
        #cosmos {
            position: fixed;
            inset: 0;
            z-index: -1;
        }

        /* Entry Portal */
        #entry-portal {
            position: fixed;
            inset: 0;
            background: var(--void);
            display: grid;
            place-items: center;
            z-index: 1000;
            transition: opacity 1.4s cubic-bezier(0.4, 0, 0.2, 1), visibility 1.4s;
        }

        #entry-portal.dissolved {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }

        .portal-content {
            text-align: center;
            padding: 2rem;
        }

        .portal-subtitle {
            font-size: 0.75rem;
            letter-spacing: 0.6em;
            color: var(--text-dim);
            text-transform: uppercase;
            margin-bottom: 1.5rem;
            opacity: 0;
            animation: fadeInUp 1s ease forwards 0.3s;
        }

        .title-scramble {
            font-family: 'Cinzel', serif;
            font-size: clamp(1.8rem, 5vw, 3.5rem);
            font-weight: 400;
            letter-spacing: 0.25em;
            background: linear-gradient(135deg, var(--starlight) 0%, var(--gravity-cyan) 50%, var(--warm-gold) 100%);
            background-size: 200% auto;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: shimmer 3s ease-in-out infinite;
            margin-bottom: 0.5rem;
        }

        @keyframes shimmer {
            0%, 100% { background-position: 0% center; }
            50% { background-position: 100% center; }
        }

        .portal-date {
            font-size: 1rem;
            letter-spacing: 0.3em;
            color: var(--gravity-cyan);
            margin-top: 0.5rem;
            opacity: 0;
            animation: fadeInUp 1s ease forwards 0.6s;
        }

        .enter-btn {
            margin-top: 3rem;
            padding: 1.2rem 3.5rem;
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.15);
            color: var(--starlight);
            font-family: 'Cinzel', serif;
            font-size: 0.8rem;
            letter-spacing: 0.4em;
            text-transform: uppercase;
            cursor: none;
            position: relative;
            overflow: hidden;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            opacity: 0;
            animation: fadeInUp 1s ease forwards 0.9s;
        }

        .enter-btn::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(90deg, transparent, rgba(0, 212, 255, 0.1), transparent);
            transform: translateX(-100%);
            transition: transform 0.6s ease;
        }

        .enter-btn:hover {
            border-color: var(--gravity-cyan);
            box-shadow: 0 0 40px rgba(0, 212, 255, 0.15), inset 0 0 20px rgba(0, 212, 255, 0.05);
            transform: translateY(-3px);
        }

        .enter-btn:hover::before {
            transform: translateX(100%);
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Main Content */
        #main-content {
            max-width: 1000px;
            margin: 0 auto;
            padding: 100px 24px;
            opacity: 0;
            transform: translateY(30px);
            transition: opacity 1.5s ease 0.3s, transform 1.5s ease 0.3s;
        }

        #main-content.revealed {
            opacity: 1;
            transform: translateY(0);
        }

        /* Section Headers */
        .section-header {
            text-align: center;
            margin-bottom: 60px;
        }

        .section-header h1 {
            font-family: 'Cinzel', serif;
            font-size: clamp(2rem, 4vw, 3rem);
            font-weight: 400;
            letter-spacing: 0.15em;
            margin-bottom: 0.5rem;
        }

        .section-header h1 .highlight {
            color: var(--gravity-cyan);
            text-shadow: 0 0 30px rgba(0, 212, 255, 0.3);
        }

        .section-header .tagline {
            font-size: 0.85rem;
            letter-spacing: 0.5em;
            color: var(--text-dim);
            text-transform: uppercase;
        }

        /* Music Player */
        .music-vessel {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.02), rgba(255, 255, 255, 0.05));
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 24px;
            padding: 28px;
            max-width: 420px;
            margin: 0 auto 80px;
            position: relative;
            overflow: hidden;
        }

        .music-vessel::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 200%;
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--gravity-cyan), transparent);
            animation: scanline-h 4s linear infinite;
        }

        @keyframes scanline-h {
            to { left: 100%; }
        }

        .track-meta {
            text-align: center;
            margin-bottom: 20px;
        }

        .track-title {
            font-family: 'Cinzel', serif;
            font-size: 1.1rem;
            letter-spacing: 0.1em;
            margin-bottom: 4px;
        }

        .track-artist {
            font-size: 0.8rem;
            color: var(--text-dim);
            font-style: italic;
        }

        #visualizer-container {
            height: 50px;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            gap: 3px;
        }

        .viz-bar {
            width: 4px;
            min-height: 3px;
            background: linear-gradient(to top, var(--nebula-core), var(--gravity-cyan));
            border-radius: 2px;
            transform-origin: bottom;
            transition: height 0.05s ease-out;
        }

        .music-status {
            text-align: center;
            margin-top: 15px;
            font-size: 0.7rem;
            letter-spacing: 0.3em;
            color: var(--text-dim);
            text-transform: uppercase;
        }

        /* Memory Gallery */
        .memory-gallery {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: 20px;
            margin: 80px 0;
        }

        .memory-frame {
            position: relative;
            overflow: hidden;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: transform 0.5s ease, box-shadow 0.5s ease;
        }

        .memory-frame:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4), 0 0 40px rgba(0, 212, 255, 0.1);
        }

        .memory-frame::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(180deg, transparent 60%, rgba(0, 0, 0, 0.7));
            pointer-events: none;
        }

        /* Portrait image - K1 */
        .memory-frame.portrait {
            grid-column: span 4;
            aspect-ratio: 3/4;
        }

        /* Landscape images - K2, K3 */
        .memory-frame.landscape {
            grid-column: span 6;
            aspect-ratio: 16/10;
        }

        .memory-frame.landscape:last-child {
            grid-column: 4 / span 6;
        }

        .memory-frame img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.6s ease;
        }

        .memory-frame:hover img {
            transform: scale(1.08);
        }

        .memory-label {
            position: absolute;
            bottom: 16px;
            left: 16px;
            font-size: 0.75rem;
            letter-spacing: 0.2em;
            color: rgba(255, 255, 255, 0.8);
            text-transform: uppercase;
            z-index: 2;
            opacity: 0;
            transform: translateY(10px);
            transition: opacity 0.4s, transform 0.4s;
        }

        .memory-frame:hover .memory-label {
            opacity: 1;
            transform: translateY(0);
        }

        /* The Letter */
        .letter-vessel {
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.01), rgba(255, 255, 255, 0.03));
            border-left: 2px solid var(--nebula-core);
            padding: 50px 50px 50px 60px;
            margin: 80px 0;
            position: relative;
        }

        .letter-vessel::before {
            content: '"';
            position: absolute;
            top: 20px;
            left: 20px;
            font-size: 4rem;
            color: var(--nebula-core);
            opacity: 0.3;
            font-family: Georgia, serif;
        }

        .letter-vessel p {
            font-size: 1.15rem;
            margin-bottom: 1.8rem;
            color: rgba(255, 255, 255, 0.9);
            text-indent: 2rem;
        }

        .letter-vessel p:last-child {
            margin-bottom: 0;
        }

        .letter-vessel .emphasis {
            color: var(--gravity-cyan);
            font-style: italic;
        }

        .letter-vessel .strong-love {
            color: var(--warm-gold);
            font-weight: 600;
            text-shadow: 0 0 20px rgba(255, 201, 64, 0.3);
        }

        /* Signature */
        .signature-block {
            text-align: center;
            margin: 100px 0 60px;
            padding: 40px;
        }

        .signature-text {
            font-size: 2.5rem;
            font-style: italic;
            background: linear-gradient(135deg, var(--gravity-cyan), var(--soft-blush), var(--warm-gold));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 1rem;
        }

        .final-words {
            font-family: 'Cinzel', serif;
            font-size: 1.2rem;
            letter-spacing: 0.3em;
            color: var(--starlight);
            text-transform: uppercase;
        }

        /* Floating Elements */
        .floating-element {
            position: fixed;
            pointer-events: none;
            opacity: 0.03;
            font-size: 15rem;
            font-family: 'Cinzel', serif;
            color: var(--starlight);
            z-index: -1;
        }

        .floating-element.left { left: -5%; top: 30%; }
        .floating-element.right { right: -5%; bottom: 20%; }

        /* Scroll Reveal */
        .reveal {
            opacity: 0;
            transform: translateY(40px);
            transition: opacity 0.8s ease, transform 0.8s ease;
        }

        .reveal.visible {
            opacity: 1;
            transform: translateY(0);
        }

        /* Asset Error State */
        .asset-error {
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 107, 157, 0.1);
            border: 1px dashed rgba(255, 107, 157, 0.3);
            color: var(--soft-blush);
            font-size: 0.8rem;
            letter-spacing: 0.1em;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .cursor-glow, .cursor-ring { display: none; }
            body { cursor: auto; }
            
            .memory-gallery {
                grid-template-columns: 1fr;
            }
            
            .memory-frame.portrait,
            .memory-frame.landscape,
            .memory-frame.landscape:last-child {
                grid-column: span 1;
            }
            
            .memory-frame.portrait { aspect-ratio: 3/4; }
            .memory-frame.landscape { aspect-ratio: 16/9; }
            
            .letter-vessel {
                padding: 30px 20px 30px 30px;
            }
            
            .floating-element { display: none; }
        }

        /* Loading State */
        .loading-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 10px 20px;
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            font-size: 0.7rem;
            letter-spacing: 0.2em;
            color: var(--text-dim);
            z-index: 9999;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .loading-indicator.active { opacity: 1; }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600&family=Cormorant+Garamond:ital,wght@0,300;0,400;0,600;1,400&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Custom Cursor -->
    <div class="cursor-glow" id="cursor-glow"></div>
    <div class="cursor-ring" id="cursor-ring"></div>

    <!-- Cosmos Background -->
    <canvas id="cosmos"></canvas>

    <!-- Floating Typography -->
    <div class="floating-element left">K</div>
    <div class="floating-element right">B</div>

    <!-- Entry Portal -->
    <div id="entry-portal">
        <div class="portal-content">
            <p class="portal-subtitle">A Memory Preserved in Stars</p>
            <h1 class="title-scramble" id="scramble-target">HAPPY BIRTHDAY</h1>
            <p class="portal-date">For You, On This Day</p>
            <button class="enter-btn" id="enter-btn">Enter Memory</button>
        </div>
    </div>

    <!-- Main Content -->
    <main id="main-content">
        
        <!-- Header -->
        <header class="section-header reveal">
            <h1>To <span class="highlight">You</span></h1>
            <p class="tagline">A constellation of moments</p>
        </header>

        <!-- Music Player -->
        <section class="music-vessel reveal">
            <div class="track-meta">
                <p class="track-title">Fallen Down</p>
                <p class="track-artist">Toby Fox</p>
            </div>
            <div id="visualizer-container"></div>
            <p class="music-status" id="music-status">Click to begin</p>
            <audio id="audio-player" loop crossorigin="anonymous">
                <source src="fallen-down.mp3" type="audio/mpeg">
            </audio>
        </section>

        <!-- Memory Gallery -->
        <section class="memory-gallery">
            <figure class="memory-frame portrait reveal">
                <img src="K1.png" alt="Memory One" id="img-k1" loading="lazy">
                <figcaption class="memory-label">Moment I</figcaption>
            </figure>
            <figure class="memory-frame landscape reveal">
                <img src="K2.png" alt="Memory Two" id="img-k2" loading="lazy">
                <figcaption class="memory-label">Moment II</figcaption>
            </figure>
            <figure class="memory-frame landscape reveal">
                <img src="K3.png" alt="Memory Three" id="img-k3" loading="lazy">
                <figcaption class="memory-label">Moment III</figcaption>
            </figure>
        </section>

        <!-- The Letter -->
        <article class="letter-vessel reveal">
            <p>Today marks another revolution around the sun since the universe decided to gift us with your existence. Every orbit you complete adds another layer to the extraordinary person you are becoming.</p>
            
            <p>You possess a light that cannot be manufactured or imitated. It exists in the way you think, in the kindness you extend without expectation, in the quiet strength you carry through each day. You are <span class="emphasis">remarkable</span>, not for any single grand gesture, but for the constellation of small beauties that make up who you are.</p>
            
            <p>Your presence transforms ordinary moments into memories worth preserving. Your laughter is a melody that lingers long after it fades. Your resilience inspires without demanding recognition. You are art in motion, poetry unwritten, a story that grows more beautiful with each chapter.</p>
            
            <p>On this day that celebrates your beginning, I want you to know that you are <span class="emphasis">enough</span>. More than enough. You are a gift that I never knew I was waiting for, a answer to questions I had not yet learned to ask.</p>
            
            <p>Happy Birthday, my love. May this year bring you every joy you deserve, every dream you dare to chase, every moment of peace your soul craves.</p>
            
            <p><span class="strong-love">I love you.</span></p>
        </article>

        <!-- Signature -->
        <footer class="signature-block reveal">
            <p class="signature-text">Forever Yours</p>
            <p class="final-words">With All My Heart</p>
        </footer>

    </main>

    <!-- Loading Indicator -->
    <div class="loading-indicator" id="loading-indicator">Loading assets...</div>

    <script>
    /**
     * Birthday Memory Website
     * Functional Programming Paradigm with TypeScript-like annotations
     * Optimized for performance with lazy evaluation patterns
     */

    // ═══════════════════════════════════════════════════════════════════════════
    // TYPE DEFINITIONS (JSDoc for TypeScript-like safety)
    // ═══════════════════════════════════════════════════════════════════════════

    /**
     * @typedef {Object} Star
     * @property {number} x
     * @property {number} y
     * @property {number} z
     * @property {number} size
     * @property {number} brightness
     */

    /**
     * @typedef {Object} Vec2
     * @property {number} x
     * @property {number} y
     */

    /**
     * @typedef {'loading' | 'ready' | 'playing' | 'error'} AudioState
     */

    // ═══════════════════════════════════════════════════════════════════════════
    // FUNCTIONAL PROGRAMMING UTILITIES (Pure, Composable)
    // ═══════════════════════════════════════════════════════════════════════════

    /** @type {<T, R>(...fns: Array<(arg: any) => any>) => (x: T) => R} */
    const pipe = (...fns) => x => fns.reduce((v, f) => f(v), x);

    /** @type {<T, R>(...fns: Array<(arg: any) => any>) => (x: T) => R} */
    const compose = (...fns) => x => fns.reduceRight((v, f) => f(v), x);

    /** @type {<T>(fn: (x: T) => T) => (x: T) => T} */
    const identity = x => x;

    /** @type {<T, R>(fn: (x: T) => R) => (x: T) => R} */
    const memoize = fn => {
        const cache = new Map();
        return x => {
            if (cache.has(x)) return cache.get(x);
            const result = fn(x);
            cache.set(x, result);
            return result;
        };
    };

    /** @type {<T>(ms: number) => (fn: (...args: T[]) => void) => (...args: T[]) => void} */
    const debounce = ms => fn => {
        let timeoutId;
        return (...args) => {
            clearTimeout(timeoutId);
            timeoutId = setTimeout(() => fn(...args), ms);
        };
    };

    /** @type {<T>(ms: number) => (fn: (...args: T[]) => void) => (...args: T[]) => void} */
    const throttle = ms => fn => {
        let lastCall = 0;
        return (...args) => {
            const now = Date.now();
            if (now - lastCall >= ms) {
                lastCall = now;
                fn(...args);
            }
        };
    };

    // ═══════════════════════════════════════════════════════════════════════════
    // MAYBE MONAD (Null Safety Pattern - Haskell Inspired)
    // ═══════════════════════════════════════════════════════════════════════════

    const Maybe = {
        /** @type {<T>(x: T | null | undefined) => MaybeMonad<T>} */
        of: x => ({
            isNothing: () => x == null,
            isJust: () => x != null,
            map: fn => x == null ? Maybe.of(null) : Maybe.of(fn(x)),
            flatMap: fn => x == null ? Maybe.of(null) : fn(x),
            getOrElse: fallback => x ?? fallback,
            fold: (onNothing, onJust) => x == null ? onNothing() : onJust(x),
            tap: fn => { if (x != null) fn(x); return Maybe.of(x); }
        }),
        /** @type {() => MaybeMonad<null>} */
        nothing: () => Maybe.of(null)
    };

    // ═══════════════════════════════════════════════════════════════════════════
    // EITHER MONAD (Error Handling - Rust Result<T, E> Inspired)
    // ═══════════════════════════════════════════════════════════════════════════

    const Either = {
        /** @type {<T>(x: T) => EitherMonad<T>} */
        right: x => ({
            isRight: true,
            isLeft: false,
            map: fn => Either.right(fn(x)),
            flatMap: fn => fn(x),
            fold: (_, onRight) => onRight(x),
            getOrElse: () => x
        }),
        /** @type {<E>(err: E) => EitherMonad<E>} */
        left: err => ({
            isRight: false,
            isLeft: true,
            map: () => Either.left(err),
            flatMap: () => Either.left(err),
            fold: (onLeft, _) => onLeft(err),
            getOrElse: fallback => fallback
        }),
        /** @type {<T>(fn: () => T) => EitherMonad<T>} */
        tryCatch: fn => {
            try { return Either.right(fn()); }
            catch (e) { return Either.left(e); }
        }
    };

    // ═══════════════════════════════════════════════════════════════════════════
    // LAZY EVALUATION (Haskell Thunk Pattern)
    // ═══════════════════════════════════════════════════════════════════════════

    /** @type {<T>(fn: () => T) => { force: () => T }} */
    const lazy = fn => {
        let evaluated = false;
        let value;
        return {
            force: () => {
                if (!evaluated) {
                    value = fn();
                    evaluated = true;
                }
                return value;
            }
        };
    };

    // ═══════════════════════════════════════════════════════════════════════════
    // IMMUTABLE STATE MANAGEMENT
    // ═══════════════════════════════════════════════════════════════════════════

    /** @type {<T>(initial: T) => { get: () => T, set: (x: T) => void, update: (fn: (x: T) => T) => void }} */
    const createState = initial => {
        let state = Object.freeze(initial);
        const listeners = new Set();
        return {
            get: () => state,
            set: newState => {
                state = Object.freeze(newState);
                listeners.forEach(fn => fn(state));
            },
            update: fn => {
                state = Object.freeze(fn(state));
                listeners.forEach(fn => fn(state));
            },
            subscribe: fn => {
                listeners.add(fn);
                return () => listeners.delete(fn);
            }
        };
    };

    // ═══════════════════════════════════════════════════════════════════════════
    // MATHEMATICAL UTILITIES (Optimized)
    // ═══════════════════════════════════════════════════════════════════════════

    const clamp = (min, max) => x => Math.max(min, Math.min(max, x));
    const lerp = (a, b) => t => a + (b - a) * t;
    const inverseLerp = (a, b) => x => (x - a) / (b - a);
    const remap = (inMin, inMax, outMin, outMax) => pipe(
        inverseLerp(inMin, inMax),
        clamp(0, 1),
        lerp(outMin, outMax)
    );
    const easeOutCubic = t => 1 - Math.pow(1 - t, 3);
    const easeInOutQuad = t => t < 0.5 ? 2 * t * t : 1 - Math.pow(-2 * t + 2, 2) / 2;

    // Pre-computed random values for performance
    const randomPool = Float32Array.from({ length: 1000 }, Math.random);
    let randomIndex = 0;
    const fastRandom = () => randomPool[randomIndex++ % randomPool.length];

    // ═══════════════════════════════════════════════════════════════════════════
    // DOM UTILITIES (Pure Functions)
    // ═══════════════════════════════════════════════════════════════════════════

    /** @type {(selector: string) => MaybeMonad<Element>} */
    const $ = selector => Maybe.of(document.querySelector(selector));

    /** @type {(selector: string) => Element[]} */
    const $$ = selector => [...document.querySelectorAll(selector)];

    /** @type {(className: string) => (el: Element) => Element} */
    const addClass = className => el => { el.classList.add(className); return el; };

    /** @type {(className: string) => (el: Element) => Element} */
    const removeClass = className => el => { el.classList.remove(className); return el; };

    /** @type {(text: string) => (el: Element) => Element} */
    const setText = text => el => { el.textContent = text; return el; };

    /** @type {(styles: Record<string, string>) => (el: Element) => Element} */
    const setStyles = styles => el => { Object.assign(el.style, styles); return el; };

    // ═══════════════════════════════════════════════════════════════════════════
    // ASSET LOADING (Concurrent, Error-Resilient)
    // ═══════════════════════════════════════════════════════════════════════════

    /** @type {(src: string) => Promise<EitherMonad<HTMLImageElement>>} */
    const loadImage = src => new Promise(resolve => {
        const img = new Image();
        img.onload = () => resolve(Either.right(img));
        img.onerror = err => {
            console.warn(`[Asset] Failed to load image: ${src}`);
            resolve(Either.left({ src, error: err }));
        };
        img.src = src;
    });

    /** @type {(src: string) => Promise<EitherMonad<HTMLAudioElement>>} */
    const loadAudio = src => new Promise(resolve => {
        const audio = document.getElementById('audio-player');
        if (audio && audio.readyState >= 2) {
            resolve(Either.right(audio));
        } else if (audio) {
            audio.oncanplaythrough = () => resolve(Either.right(audio));
            audio.onerror = err => {
                console.warn(`[Asset] Failed to load audio: ${src}`);
                resolve(Either.left({ src, error: err }));
            };
        } else {
            resolve(Either.left({ src, error: 'No audio element' }));
        }
    });

    /** @type {(assets: string[]) => Promise<Map<string, EitherMonad<any>>>} */
    const loadAllAssets = async assets => {
        const results = await Promise.all(
            assets.map(async src => {
                const isImage = /\.(png|jpg|jpeg|gif|webp|svg)$/i.test(src);
                const result = isImage ? await loadImage(src) : await loadAudio(src);
                return [src, result];
            })
        );
        return new Map(results);
    };

    // ═══════════════════════════════════════════════════════════════════════════
    // COSMOS RENDERER (Optimized Starfield)
    // ═══════════════════════════════════════════════════════════════════════════

    const createCosmosRenderer = canvas => {
        const ctx = canvas.getContext('2d', { alpha: false });
        let width = 0;
        let height = 0;
        let stars = new Float32Array(0);
        const STAR_COUNT = 600;
        const STAR_PROPS = 5; // x, y, z, size, brightness
        let warpSpeed = 0;
        let targetSpeed = 1.5;
        let animationId = null;

        const resize = () => {
            width = window.innerWidth;
            height = window.innerHeight;
            canvas.width = width;
            canvas.height = height;
            initializeStars();
        };

        const initializeStars = () => {
            stars = new Float32Array(STAR_COUNT * STAR_PROPS);
            for (let i = 0; i < STAR_COUNT; i++) {
                resetStar(i, true);
            }
        };

        const resetStar = (index, initial = false) => {
            const base = index * STAR_PROPS;
            stars[base] = (fastRandom() - 0.5) * width * 2;      // x
            stars[base + 1] = (fastRandom() - 0.5) * height * 2; // y
            stars[base + 2] = initial ? fastRandom() * 2000 : 2000; // z
            stars[base + 3] = fastRandom() * 1.5 + 0.5;          // size
            stars[base + 4] = fastRandom() > 0.85 ? 1 : 0;       // brightness type
        };

        const render = () => {
            // Smooth speed interpolation
            warpSpeed += (targetSpeed - warpSpeed) * 0.05;

            // Clear with trail effect
            ctx.fillStyle = 'rgba(2, 2, 4, 0.25)';
            ctx.fillRect(0, 0, width, height);

            const halfW = width * 0.5;
            const halfH = height * 0.5;
            const focalLength = 400;

            for (let i = 0; i < STAR_COUNT; i++) {
                const base = i * STAR_PROPS;
                
                // Update position
                stars[base + 2] -= warpSpeed;
                if (stars[base + 2] <= 1) resetStar(i, false);

                const z = stars[base + 2];
                const scale = focalLength / z;
                const x = stars[base] * scale + halfW;
                const y = stars[base + 1] * scale + halfH;

                // Frustum culling
                if (x < -10 || x > width + 10 || y < -10 || y > height + 10) continue;

                const size = stars[base + 3] * scale;
                const alpha = clamp(0, 1)((2000 - z) / 1500);

                // Draw star
                ctx.beginPath();
                ctx.arc(x, y, Math.max(0.5, size), 0, Math.PI * 2);
                ctx.fillStyle = stars[base + 4] 
                    ? `rgba(0, 212, 255, ${alpha})` 
                    : `rgba(228, 230, 242, ${alpha})`;
                ctx.fill();

                // Warp streak effect
                if (warpSpeed > 5) {
                    const streakLength = warpSpeed * scale * 0.5;
                    ctx.beginPath();
                    ctx.moveTo(x, y);
                    ctx.lineTo(x, y + streakLength);
                    ctx.strokeStyle = `rgba(200, 220, 255, ${alpha * 0.3})`;
                    ctx.lineWidth = size * 0.5;
                    ctx.stroke();
                }
            }

            animationId = requestAnimationFrame(render);
        };

        const start = () => {
            resize();
            window.addEventListener('resize', debounce(100)(resize));
            render();
        };

        const setWarpSpeed = speed => { targetSpeed = speed; };

        const triggerWarp = () => {
            warpSpeed = 60;
            setTimeout(() => { targetSpeed = 1.5; }, 800);
        };

        const destroy = () => {
            if (animationId) cancelAnimationFrame(animationId);
        };

        return { start, setWarpSpeed, triggerWarp, destroy };
    };

    // ═══════════════════════════════════════════════════════════════════════════
    // TEXT SCRAMBLER (Optimized - Fast Version)
    // ═══════════════════════════════════════════════════════════════════════════

    const createTextScrambler = element => {
        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
        const charsLen = chars.length;
        
        return targetText => new Promise(resolve => {
            const totalFrames = 20; // Very fast
            let frame = 0;
            const textLen = targetText.length;
            
            const animate = () => {
                const progress = frame / totalFrames;
                const revealIndex = Math.floor(progress * textLen * 1.3);
                
                let result = '';
                for (let i = 0; i < textLen; i++) {
                    if (i < revealIndex) {
                        result += targetText[i];
                    } else {
                        result += chars[Math.floor(fastRandom() * charsLen)];
                    }
                }
                
                element.textContent = result;
                frame++;
                
                if (frame <= totalFrames) {
                    requestAnimationFrame(animate);
                } else {
                    element.textContent = targetText;
                    resolve();
                }
            };
            
            requestAnimationFrame(animate);
        });
    };

    // ═══════════════════════════════════════════════════════════════════════════
    // AUDIO VISUALIZER (Web Audio API)
    // ═══════════════════════════════════════════════════════════════════════════

    const createVisualizer = (audioElement, container) => {
        const BAR_COUNT = 24;
        const bars = [];
        let audioContext = null;
        let analyser = null;
        let dataArray = null;
        let animationId = null;

        // Create bars
        for (let i = 0; i < BAR_COUNT; i++) {
            const bar = document.createElement('div');
            bar.className = 'viz-bar';
            container.appendChild(bar);
            bars.push(bar);
        }

        const initialize = () => {
            if (audioContext) return Either.right(analyser);
            
            return Either.tryCatch(() => {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 64;
                analyser.smoothingTimeConstant = 0.8;
                
                const source = audioContext.createMediaElementSource(audioElement);
                source.connect(analyser);
                analyser.connect(audioContext.destination);
                
                dataArray = new Uint8Array(analyser.frequencyBinCount);
                return analyser;
            });
        };

        const render = () => {
            if (!analyser || !dataArray) return;
            
            analyser.getByteFrequencyData(dataArray);
            
            bars.forEach((bar, i) => {
                const value = dataArray[i] || 0;
                const height = Math.max(3, (value / 255) * 45);
                bar.style.height = `${height}px`;
            });
            
            animationId = requestAnimationFrame(render);
        };

        const start = () => {
            const result = initialize();
            result.fold(
                err => console.warn('[Audio] Visualizer error:', err),
                () => render()
            );
        };

        const stop = () => {
            if (animationId) cancelAnimationFrame(animationId);
        };

        return { start, stop, bars };
    };

    // ═══════════════════════════════════════════════════════════════════════════
    // CUSTOM CURSOR
    // ═══════════════════════════════════════════════════════════════════════════

    const createCustomCursor = (glowEl, ringEl) => {
        let mouseX = 0;
        let mouseY = 0;
        let ringX = 0;
        let ringY = 0;

        const onMouseMove = throttle(16)(e => {
            mouseX = e.clientX;
            mouseY = e.clientY;
            glowEl.style.left = `${mouseX}px`;
            glowEl.style.top = `${mouseY}px`;
        });

        const animateRing = () => {
            ringX += (mouseX - ringX) * 0.15;
            ringY += (mouseY - ringY) * 0.15;
            ringEl.style.left = `${ringX}px`;
            ringEl.style.top = `${ringY}px`;
            requestAnimationFrame(animateRing);
        };

        const expandRing = () => ringEl.classList.add('expanded');
        const shrinkRing = () => ringEl.classList.remove('expanded');

        const start = () => {
            document.addEventListener('mousemove', onMouseMove);
            animateRing();
            
            $$('button, a, .memory-frame').forEach(el => {
                el.addEventListener('mouseenter', expandRing);
                el.addEventListener('mouseleave', shrinkRing);
            });
        };

        return { start };
    };

    // ═══════════════════════════════════════════════════════════════════════════
    // SCROLL REVEAL (Intersection Observer)
    // ═══════════════════════════════════════════════════════════════════════════

    const createScrollReveal = () => {
        const observer = new IntersectionObserver(
            entries => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('visible');
                        observer.unobserve(entry.target);
                    }
                });
            },
            { threshold: 0.15, rootMargin: '0px 0px -50px 0px' }
        );

        const observe = () => {
            $$('.reveal').forEach(el => observer.observe(el));
        };

        return { observe };
    };

    // ═══════════════════════════════════════════════════════════════════════════
    // LOADING INDICATOR
    // ═══════════════════════════════════════════════════════════════════════════

    const createLoadingIndicator = indicatorEl => ({
        show: msg => {
            indicatorEl.textContent = msg;
            indicatorEl.classList.add('active');
        },
        hide: () => indicatorEl.classList.remove('active')
    });

    // ═══════════════════════════════════════════════════════════════════════════
    // MAIN APPLICATION (Composition Root)
    // ═══════════════════════════════════════════════════════════════════════════

    const initializeApp = async () => {
        // State
        const appState = createState({
            assetsLoaded: false,
            audioPlaying: false,
            entered: false
        });

        // DOM Elements (with Maybe safety)
        const elements = {
            cosmos: $('canvas#cosmos'),
            entryPortal: $('#entry-portal'),
            enterBtn: $('#enter-btn'),
            mainContent: $('#main-content'),
            scrambleTarget: $('#scramble-target'),
            audioPlayer: $('#audio-player'),
            visualizerContainer: $('#visualizer-container'),
            musicStatus: $('#music-status'),
            cursorGlow: $('#cursor-glow'),
            cursorRing: $('#cursor-ring'),
            loadingIndicator: $('#loading-indicator')
        };

        // Validate critical elements
        const criticalElements = ['cosmos', 'entryPortal', 'enterBtn', 'mainContent'];
        const missingElements = criticalElements.filter(
            key => elements[key].isNothing()
        );
        
        if (missingElements.length > 0) {
            console.error('[App] Missing critical elements:', missingElements);
            return;
        }

        // Initialize loading indicator
        const loadingIndicator = elements.loadingIndicator
            .map(createLoadingIndicator)
            .getOrElse({ show: () => {}, hide: () => {} });

        loadingIndicator.show('Initializing cosmos...');

        // Initialize cosmos renderer
        const cosmos = elements.cosmos
            .map(createCosmosRenderer)
            .getOrElse(null);
        
        if (cosmos) cosmos.start();

        // Initialize text scrambler
        const scrambler = elements.scrambleTarget
            .map(createTextScrambler)
            .getOrElse(() => Promise.resolve());

        // Run initial scramble animation
        setTimeout(() => scrambler('HAPPY BIRTHDAY'), 500);

        // Initialize custom cursor (desktop only)
        if (window.matchMedia('(pointer: fine)').matches) {
            Maybe.of(elements.cursorGlow.getOrElse(null))
                .flatMap(glow => 
                    elements.cursorRing.map(ring => ({ glow, ring }))
                )
                .tap(({ glow, ring }) => {
                    createCustomCursor(glow, ring).start();
                });
        }

        // Load assets concurrently
        loadingIndicator.show('Loading memories...');
        const assetPaths = ['K1.png', 'K2.png', 'K3.png', 'fallen-down.mp3'];
        const assetResults = await loadAllAssets(assetPaths);

        // Handle asset loading results
        assetResults.forEach((result, path) => {
            result.fold(
                err => console.warn(`[Asset] ${path} failed to load:`, err),
                () => console.log(`[Asset] ${path} loaded successfully`)
            );
        });

        // Mark images with error state if they failed
        ['K1.png', 'K2.png', 'K3.png'].forEach((src, i) => {
            const imgId = `#img-k${i + 1}`;
            $(imgId).tap(img => {
                const result = assetResults.get(src);
                if (result && result.isLeft) {
                    img.parentElement.classList.add('asset-error');
                    img.alt = 'Memory unavailable';
                }
            });
        });

        loadingIndicator.hide();

        // Initialize audio and visualizer
        let visualizer = null;
        elements.audioPlayer.tap(audio => {
            elements.visualizerContainer.tap(container => {
                visualizer = createVisualizer(audio, container);
            });
        });

        // Initialize scroll reveal
        const scrollReveal = createScrollReveal();

        // Entry button handler
        elements.enterBtn.tap(btn => {
            btn.addEventListener('click', () => {
                if (appState.get().entered) return;
                
                appState.update(s => ({ ...s, entered: true }));

                // Trigger warp effect
                if (cosmos) cosmos.triggerWarp();

                // Dissolve entry portal
                elements.entryPortal.tap(addClass('dissolved'));

                // Reveal main content
                setTimeout(() => {
                    elements.mainContent.tap(addClass('revealed'));
                    scrollReveal.observe();
                }, 600);

                // Start audio
                elements.audioPlayer.tap(audio => {
                    audio.play()
                        .then(() => {
                            appState.update(s => ({ ...s, audioPlaying: true }));
                            elements.musicStatus.tap(setText('Now playing'));
                            if (visualizer) visualizer.start();
                        })
                        .catch(err => {
                            console.warn('[Audio] Playback blocked:', err);
                            elements.musicStatus.tap(setText('Click to play'));
                            
                            // Add click-to-play on music vessel
                            $('.music-vessel').tap(vessel => {
                                const playHandler = () => {
                                    audio.play().then(() => {
                                        elements.musicStatus.tap(setText('Now playing'));
                                        if (visualizer) visualizer.start();
                                        vessel.removeEventListener('click', playHandler);
                                    });
                                };
                                vessel.addEventListener('click', playHandler);
                            });
                        });
                });
            });
        });

        console.log('[App] Birthday memory website initialized successfully');
        console.log('[App] Functional programming patterns active');
        console.log('[App] All systems operational');
    };

    // ═══════════════════════════════════════════════════════════════════════════
    // BOOTSTRAP
    // ═══════════════════════════════════════════════════════════════════════════

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeApp);
    } else {
        initializeApp();
    }
    </script>
</body>
</html>
